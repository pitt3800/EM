<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‘ê¸‰ì‹¤ ìš´ì˜ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ - ì—°êµ¬ ë°ì´í„° ê³µìœ  í”Œë«í¼</title>
    
    <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ========================================
           ğŸ“¦ MODULE: ê¸°ë³¸ CSS ë³€ìˆ˜ ë° ìŠ¤íƒ€ì¼
           ======================================== */
        :root {
            --primary-color: #2563eb;
            --secondary-color: #f8fafc;
            --accent-color: #06b6d4;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1e293b;
            --light-color: #f1f5f9;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        body {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #e2e8f0 100%);
            font-family: 'Inter', 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ========================================
           ğŸ“¦ MODULE: í—¤ë” ìŠ¤íƒ€ì¼
           ======================================== */
        .header-section {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .header-section .container {
            position: relative;
            z-index: 1;
        }

        .header-section h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-section .lead {
            font-size: 1.2rem;
            font-weight: 400;
            opacity: 0.95;
            margin-bottom: 1rem;
        }

        /* ========================================
           ğŸ“¦ MODULE: ê³µìœ  ìƒíƒœ ì•Œë¦¼
           ======================================== */
        .sharing-status {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 2px solid #22c55e;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
        }

        .sharing-status.demo-mode {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
        }

        .sharing-status.no-data {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: #ef4444;
        }

        /* ========================================
           ğŸ“¦ MODULE: ì¹´ë“œ ë° ëª¨ë“ˆ ìŠ¤íƒ€ì¼
           ======================================== */
        .module-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .module-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .module-header {
            background: linear-gradient(135deg, var(--dark-color) 0%, #334155 100%);
            color: white;
            padding: 1.5rem 2rem;
            font-weight: 600;
            font-size: 1.2em;
            border-radius: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .module-header i {
            font-size: 1.3em;
            opacity: 0.9;
        }

        .card-body {
            padding: 2rem;
        }

        /* ========================================
           ğŸ“¦ MODULE: ë²„íŠ¼ ìŠ¤íƒ€ì¼
           ======================================== */
        .btn-primary-academic {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            border: none;
            color: white;
            font-weight: 500;
            padding: 12px 28px;
            border-radius: 10px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary-academic:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
            color: white;
        }

        .btn-success-academic {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            border: none;
            color: white;
            font-weight: 500;
            padding: 12px 28px;
            border-radius: 10px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .btn-success-academic:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
            color: white;
        }

        .btn-outline-primary {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            background: transparent;
            border-radius: 10px;
            font-weight: 500;
            padding: 10px 26px;
            transition: all 0.3s ease;
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        /* ========================================
           ğŸ“¦ MODULE: ë¡œë”© ë° ìŠ¤í”¼ë„ˆ
           ======================================== */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 3rem;
            background: var(--light-color);
            border-radius: 12px;
            margin: 1.5rem 0;
        }

        .spinner-academic {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========================================
           ğŸ“¦ MODULE: ë°ì´í„° í…Œì´ë¸”
           ======================================== */
        .data-table {
            font-size: 0.9em;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .data-table th {
            background: linear-gradient(135deg, var(--dark-color) 0%, #334155 100%);
            color: white;
            text-align: center;
            font-size: 0.85em;
            padding: 15px 12px;
            font-weight: 600;
            border: none;
        }

        .data-table td {
            text-align: center;
            padding: 12px;
            vertical-align: middle;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tbody tr:hover {
            background-color: var(--light-color);
        }

        /* ========================================
           ğŸ“¦ MODULE: íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­
           ======================================== */
        .file-drop-area {
            border: 2px dashed var(--primary-color);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .file-drop-area.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            border-color: #94a3b8;
        }

        .file-drop-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="rgba(37,99,235,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
            opacity: 0.5;
        }

        .file-drop-area > * {
            position: relative;
            z-index: 1;
        }

        .file-drop-area:hover:not(.disabled) {
            border-color: var(--accent-color);
            background: linear-gradient(135deg, #e0f2fe 0%, #cffafe 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .file-drop-area.drag-over {
            border-color: var(--success-color);
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        }

        .file-drop-area h5 {
            color: var(--dark-color);
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        /* ========================================
           ğŸ“¦ MODULE: ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ
           ======================================== */
        .chart-container {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .chart-header {
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 15px;
            margin-bottom: 25px;
            position: relative;
        }

        .chart-header::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 60px;
            height: 3px;
            background: var(--accent-color);
            border-radius: 2px;
        }

        .chart-header h5 {
            color: var(--dark-color);
            font-weight: 600;
            margin: 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* ========================================
           ğŸ“¦ MODULE: í†µê³„ ì¹´ë“œ
           ======================================== */
        .stat-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 15px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-xl);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.95;
            font-weight: 400;
            position: relative;
            z-index: 1;
        }

        /* ========================================
           ğŸ“¦ MODULE: ë¶„ì„ ë²„íŠ¼ ê·¸ë¦¬ë“œ
           ======================================== */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analysis-btn {
            background: white;
            border: 2px solid var(--border-color);
            color: var(--dark-color);
            padding: 1.5rem;
            border-radius: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .analysis-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(37,99,235,0.1), transparent);
            transition: left 0.5s ease;
        }

        .analysis-btn:hover::before {
            left: 100%;
        }

        .analysis-btn:hover {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .analysis-btn i {
            font-size: 1.8rem;
            margin-bottom: 12px;
            display: block;
            opacity: 0.8;
        }

        .analysis-btn small {
            opacity: 0.7;
            font-style: italic;
        }

        /* ========================================
           ğŸ“¦ MODULE: ë°˜ì‘í˜• ë””ìì¸
           ======================================== */
        @media (max-width: 768px) {
            .header-section h1 {
                font-size: 2rem;
            }
            
            .analysis-grid {
                grid-template-columns: 1fr;
            }
            
            .card-body {
                padding: 1.5rem;
            }
            
            .module-header {
                padding: 1rem 1.5rem;
            }
        }

        .demo-data-notice {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #64748b;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- ========================================
         ğŸ“¦ MODULE: í˜ì´ì§€ ì»¨í…Œì´ë„ˆ
         ======================================== -->
    <div class="container py-4">
        <!-- ========================================
             ğŸ“¦ MODULE: í—¤ë” ì„¹ì…˜
             ======================================== -->
        <div class="header-section">
            <div class="container">
                <h1><i class="fas fa-hospital-alt"></i> ì‘ê¸‰ì‹¤ ìš´ì˜ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</h1>
                <p class="lead">Emergency Department Operation Monitoring & Statistical Analysis</p>
            </div>
        </div>

        <!-- ========================================
             ğŸ“¦ MODULE: ê³µìœ  ìƒíƒœ ì•Œë¦¼
             ======================================== -->
        <div id="sharingStatusAlert" class="sharing-status no-data">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="mb-2">
                        <i id="statusIcon" class="fas fa-exclamation-circle"></i> 
                        <span id="statusTitle">ë°ì´í„° ëŒ€ê¸° ì¤‘</span>
                    </h5>
                    <p class="mb-0" id="statusMessage">
                        ì•„ì§ ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ë°ëª¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ ì‹œì‘í•˜ì„¸ìš”.
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-primary-academic" onclick="loadDemoData()">
                        <i class="fas fa-play"></i> ë°ëª¨ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                    </button>
                </div>
            </div>
        </div>



        <!-- ========================================
             ğŸ“¦ MODULE: í™˜ì ë°ì´í„° ë¶„ì„
             ======================================== -->
        <div class="module-card">
            <div class="module-header">
                <i class="fas fa-upload"></i> í™˜ì ë°ì´í„° ë¶„ì„
            </div>
            <div class="card-body">
                <!-- ê´€ë¦¬ì/ì—…ë¡œë“œì ëª¨ë“œ -->
                <div id="uploaderMode">
                    <!-- íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
                    <div class="file-drop-area" id="fileDropArea">
                        <i class="fas fa-cloud-upload-alt fa-4x mb-3" style="color: var(--primary-color);"></i>
                        <h5>í™˜ì ë°ì´í„° ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h5>
                        <p class="text-muted mb-3">íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</p>
                        <input type="file" id="patientFileInput" accept=".xlsx,.xls" style="display: none;">
                        <button class="btn btn-primary-academic" onclick="document.getElementById('patientFileInput').click()">
                            <i class="fas fa-folder-open"></i> íŒŒì¼ ì„ íƒ
                        </button>
                        <button class="btn btn-outline-primary ms-2" onclick="clearStoredData()">
                            <i class="fas fa-trash"></i> ì €ì¥ëœ ë°ì´í„° ì‚­ì œ
                        </button>
                    </div>
                </div>

                <!-- ì‚¬ìš©ì/ë¶„ì„ì ëª¨ë“œ -->
                <div id="userMode" style="display: none;">
                    <div class="demo-data-notice">
                        <h6><i class="fas fa-info-circle"></i> ì €ì¥ëœ ë°ì´í„° ì‚¬ìš© ì¤‘</h6>
                        <p class="mb-2">ê¸°ì¡´ì— ì—…ë¡œë“œëœ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="switchToUploaderMode()">
                            <i class="fas fa-upload"></i> ìƒˆ ë°ì´í„° ì—…ë¡œë“œ
                        </button>
                    </div>
                </div>

                <!-- ë¡œë”© ì„¹ì…˜ -->
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner-academic"></div>
                    <h6 class="mb-3">ë°ì´í„° ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</h6>
                    <div id="loadingProgress"></div>
                </div>

                <!-- ë¶„ì„ ê²°ê³¼ ì„¹ì…˜ -->
                <div id="analysisResults" style="display: none;">
                    <hr class="my-4">
                    <h6 class="mb-4"><i class="fas fa-chart-bar"></i> ë°ì´í„° ë¶„ì„ ê²°ê³¼</h6>
                    
                    <!-- ë°ì´í„° í’ˆì§ˆ ì •ë³´ -->
                    <div class="data-quality mb-4" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1rem; font-size: 0.9rem;">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6><i class="fas fa-database"></i> í˜„ì¬ ë°ì´í„°</h6>
                                <span id="currentDatasetName" class="badge bg-primary">ë¡œë“œëœ ë°ì´í„°</span>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-sm btn-outline-primary" onclick="exportPatientData()">
                                    <i class="fas fa-download"></i> ë°ì´í„° ë‚´ë³´ë‚´ê¸°
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- í†µê³„ ì¹´ë“œë“¤ -->
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="totalPatients">0</div>
                                <div class="stat-label"><i class="fas fa-users"></i> ì´ í™˜ììˆ˜</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="totalDoctors">0</div>
                                <div class="stat-label"><i class="fas fa-user-md"></i> ì‘ê¸‰ì‹¤ ì˜ì‚¬ìˆ˜</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="dateRange">-</div>
                                <div class="stat-label"><i class="fas fa-calendar-alt"></i> ë°ì´í„° ê¸°ê°„</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="avgPatientsPerDay">0</div>
                                <div class="stat-label"><i class="fas fa-clock"></i> ì¼í‰ê·  í™˜ììˆ˜</div>
                            </div>
                        </div>
                    </div>

                    <!-- ë‹¤ìŒ ë‹¨ê³„ ë²„íŠ¼ -->
                    <div class="text-center mt-4">
                        <button class="btn btn-success-academic btn-lg" onclick="goToStep2()">
                            <i class="fas fa-arrow-right"></i> í†µê³„ ë¶„ì„ ì‹œì‘
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================
             ğŸ“¦ MODULE: í†µê³„ ë¶„ì„ ë° ì°¨íŠ¸ ìƒì„±
             ======================================== -->
        <div class="module-card" id="step2Module" style="display: none;">
            <div class="module-header">
                <i class="fas fa-chart-bar"></i> í†µê³„ ë¶„ì„ ë° ì°¨íŠ¸ ìƒì„±
            </div>
            <div class="card-body">
                <!-- ë¶„ì„ ë²„íŠ¼ ê·¸ë¦¬ë“œ -->
                <div class="analysis-grid">
                    <button class="analysis-btn" onclick="safeGenerateChart(generateDailyPatientChart, 'ì¼ë³„ í™˜ììˆ˜')">
                        <i class="fas fa-calendar-day"></i>
                        ì¼ë³„ í™˜ììˆ˜ ë¶„ì„
                        <small class="d-block mt-2">Daily Patient Volume</small>
                    </button>
                    
                    <button class="analysis-btn" onclick="safeGenerateChart(generateWeeklyAverageChart, 'ìš”ì¼ë³„ í‰ê· í™˜ììˆ˜')">
                        <i class="fas fa-calendar-week"></i>
                        ìš”ì¼ë³„ í‰ê· í™˜ììˆ˜
                        <small class="d-block mt-2">Weekly Average</small>
                    </button>
                    
                    <button class="analysis-btn" onclick="safeGenerateChart(generateHourlyAverageChart, 'ì‹œê°„ëŒ€ë³„ ë‚´ì›í™˜ììˆ˜')">
                        <i class="fas fa-clock"></i>
                        ì‹œê°„ëŒ€ë³„ ë‚´ì›í™˜ììˆ˜
                        <small class="d-block mt-2">Hourly Admission</small>
                    </button>
                    
                    <button class="analysis-btn" onclick="safeGenerateChart(generateRealtimeOccupancyChart, 'ì‹¤ì‹œê°„ ë¶„ë‹¹ ì¬ì‹¤í™˜ììˆ˜')">
                        <i class="fas fa-bed"></i>
                        ì‹¤ì‹œê°„ ë¶„ë‹¹ ì¬ì‹¤í™˜ììˆ˜
                        <small class="d-block mt-2">Real-time Occupancy</small>
                    </button>
                    
                    <button class="analysis-btn" onclick="safeGenerateChart(generateKTASDistributionChart, 'KTASë³„ í™˜ì ë¶„í¬')">
                        <i class="fas fa-exclamation-triangle"></i>
                        KTASë³„ í™˜ì ë¶„í¬
                        <small class="d-block mt-2">Acuity Distribution</small>
                    </button>
                    
                    <button class="analysis-btn" onclick="safeGenerateChart(generateAdmissionVsDischargeChart, 'ì…ì› VS ê·€ê°€ ë¶„ì„')">
                        <i class="fas fa-procedures"></i>
                        ì…ì› VS ê·€ê°€ ë¶„ì„
                        <small class="d-block mt-2">Disposition Analysis</small>
                    </button>
                    
                    <button class="analysis-btn" onclick="safeGenerateChart(generateAdmissionDepartmentChart, 'ì…ì›ê³¼ë³„ í™˜ììˆ˜')">
                        <i class="fas fa-hospital"></i>
                        ì…ì›ê³¼ë³„ í™˜ììˆ˜
                        <small class="d-block mt-2">Department Distribution</small>
                    </button>
                    
                    <button class="analysis-btn" onclick="safeGenerateChart(generateDoctorPatientChart, 'ì˜ì‚¬ë³„ í™˜ììˆ˜')">
                        <i class="fas fa-user-md"></i>
                        ì‘ê¸‰ì‹¤ ì˜ì‚¬ë³„ í™˜ììˆ˜
                        <small class="d-block mt-2">Physician Workload</small>
                    </button>
                </div>

                <!-- ì „ì²´ ë¶„ì„ ì‹¤í–‰ ë²„íŠ¼ -->
                <div class="text-center mb-4">
                    <button class="btn btn-success-academic btn-lg" onclick="generateAllCharts()">
                        <i class="fas fa-chart-pie"></i> ì „ì²´ ë¶„ì„ ì°¨íŠ¸ ìƒì„±
                    </button>
                </div>

                <!-- ì°¨íŠ¸ í‘œì‹œ ì˜ì—­ -->
                <div id="chartsContainer" class="charts-container">
                    <!-- ì°¨íŠ¸ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>

    <script>
        /* ========================================
           ğŸ“¦ MODULE: ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ê´€ë¦¬
           ======================================== */
        let patientData = null;
        let analysisResults = null;
        let generatedCharts = {};
        let realtimeOccupancyData = null;
        let isDataShared = false; // ë°ì´í„°ê°€ ê³µìœ  ìƒíƒœì¸ì§€ í™•ì¸

        /* Chart.js ë°ì´í„°ë ˆì´ë¸” í”ŒëŸ¬ê·¸ì¸ ë“±ë¡ */
        Chart.register(ChartDataLabels);

        /* ========================================
           ğŸ“¦ MODULE: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬
           ======================================== */
        const StorageManager = {
            // ë°ì´í„° ì €ì¥ í‚¤
            STORAGE_KEYS: {
                PATIENT_DATA: 'er_patient_data',
                ANALYSIS_RESULTS: 'er_analysis_results',
                REALTIME_DATA: 'er_realtime_data',
                LAST_UPLOAD: 'er_last_upload_time',
                DATA_SOURCE: 'er_data_source'
            },

            // ë°ì´í„° ì €ì¥
            saveData: function(patientData, analysisResults, realtimeData = null, dataSource = 'upload') {
                try {
                    const saveTime = new Date().toISOString();
                    
                    // ë©”ì¸ ë°ì´í„° ì €ì¥
                    localStorage.setItem(this.STORAGE_KEYS.PATIENT_DATA, JSON.stringify(patientData));
                    localStorage.setItem(this.STORAGE_KEYS.ANALYSIS_RESULTS, JSON.stringify(analysisResults));
                    localStorage.setItem(this.STORAGE_KEYS.LAST_UPLOAD, saveTime);
                    localStorage.setItem(this.STORAGE_KEYS.DATA_SOURCE, dataSource);
                    
                    // ì‹¤ì‹œê°„ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì €ì¥
                    if (realtimeData) {
                        localStorage.setItem(this.STORAGE_KEYS.REALTIME_DATA, JSON.stringify(realtimeData));
                    }

                    console.log('âœ… ë°ì´í„° ì €ì¥ ì™„ë£Œ:', saveTime);
                    return true;
                } catch (error) {
                    console.error('âŒ ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
                    return false;
                }
            },

            // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            loadData: function() {
                try {
                    const patientDataStr = localStorage.getItem(this.STORAGE_KEYS.PATIENT_DATA);
                    const analysisResultsStr = localStorage.getItem(this.STORAGE_KEYS.ANALYSIS_RESULTS);
                    const realtimeDataStr = localStorage.getItem(this.STORAGE_KEYS.REALTIME_DATA);
                    const lastUpload = localStorage.getItem(this.STORAGE_KEYS.LAST_UPLOAD);
                    const dataSource = localStorage.getItem(this.STORAGE_KEYS.DATA_SOURCE) || 'unknown';

                    if (!patientDataStr || !analysisResultsStr) {
                        console.log('ğŸ“­ ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return null;
                    }

                    const data = {
                        patientData: JSON.parse(patientDataStr),
                        analysisResults: JSON.parse(analysisResultsStr),
                        realtimeData: realtimeDataStr ? JSON.parse(realtimeDataStr) : null,
                        lastUpload: lastUpload,
                        dataSource: dataSource
                    };

                    console.log('âœ… ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ:', {
                        patients: data.patientData.length,
                        lastUpload: data.lastUpload,
                        source: data.dataSource
                    });

                    return data;
                } catch (error) {
                    console.error('âŒ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
                    return null;
                }
            },

            // ë°ì´í„° ì‚­ì œ
            clearData: function() {
                try {
                    Object.values(this.STORAGE_KEYS).forEach(key => {
                        localStorage.removeItem(key);
                    });
                    console.log('âœ… ì €ì¥ëœ ë°ì´í„° ëª¨ë‘ ì‚­ì œ');
                    return true;
                } catch (error) {
                    console.error('âŒ ë°ì´í„° ì‚­ì œ ì˜¤ë¥˜:', error);
                    return false;
                }
            },

            // ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            hasData: function() {
                return localStorage.getItem(this.STORAGE_KEYS.PATIENT_DATA) !== null;
            }
        };

        /* ========================================
           ğŸ“¦ MODULE: UI ìƒíƒœ ê´€ë¦¬
           ======================================== */
        const UIStateManager = {
            // ê³µìœ  ìƒíƒœ ì—…ë°ì´íŠ¸
            updateSharingStatus: function(hasData, isDemo = false, dataSource = 'unknown') {
                const statusAlert = document.getElementById('sharingStatusAlert');
                const statusIcon = document.getElementById('statusIcon');
                const statusTitle = document.getElementById('statusTitle');
                const statusMessage = document.getElementById('statusMessage');

                if (hasData) {
                    if (isDemo) {
                        // ë°ëª¨ ë°ì´í„° ìƒíƒœ
                        statusAlert.className = 'sharing-status demo-mode';
                        statusIcon.className = 'fas fa-flask';
                        statusTitle.textContent = 'ë°ëª¨ ë°ì´í„° ì‚¬ìš© ì¤‘';
                        statusMessage.textContent = 'ìƒ˜í”Œ ë°ì´í„°ë¡œ ë¶„ì„ ê¸°ëŠ¥ì„ ì²´í—˜í•´ë³´ì„¸ìš”. ì‹¤ì œ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë³¸ê²©ì ì¸ ë¶„ì„ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                    } else {
                        // ì‹¤ì œ ë°ì´í„° ìƒíƒœ
                        statusAlert.className = 'sharing-status';
                        statusIcon.className = 'fas fa-check-circle';
                        statusTitle.textContent = 'ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ';
                        statusMessage.textContent = 'ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.';
                    }
                    
                    isDataShared = true;
                } else {
                    // ë°ì´í„° ì—†ìŒ
                    statusAlert.className = 'sharing-status no-data';
                    statusIcon.className = 'fas fa-exclamation-circle';
                    statusTitle.textContent = 'ë°ì´í„° ëŒ€ê¸° ì¤‘';
                    statusMessage.textContent = 'ì•„ì§ ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ë°ëª¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ ì‹œì‘í•˜ì„¸ìš”.';
                    isDataShared = false;
                }
            },

            // ì—…ë¡œë“œ ëª¨ë“œ vs ì‚¬ìš©ì ëª¨ë“œ ì „í™˜
            switchMode: function(mode) {
                const uploaderMode = document.getElementById('uploaderMode');
                const userMode = document.getElementById('userMode');
                
                if (mode === 'uploader') {
                    uploaderMode.style.display = 'block';
                    userMode.style.display = 'none';
                } else {
                    uploaderMode.style.display = 'none';
                    userMode.style.display = 'block';
                }
            }
        };

        /* ========================================
           ğŸ“¦ MODULE: í™˜ì ë°ì´í„° ë¶„ì„ê¸° (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
           ======================================== */
        const PatientAnalyzer = {
            config: {
                requiredColumns: ['ë‚´ì›ì¼ì', 'ë‚´ì›ì‹œê°„', 'ì‘ê¸‰ì‹¤ì˜ì‚¬'],
                timeFormats: ['HHMM', 'HH:MM'],
                dateFormats: ['YYYYMMDD', 'YYYY-MM-DD']
            },

            readExcelFile: async function(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const workbook = XLSX.read(e.target.result, { type: 'binary' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { 
                                header: 1,
                                defval: null 
                            });
                            console.log('âœ… ì—‘ì…€ íŒŒì¼ ì½ê¸° ì™„ë£Œ:', jsonData.length, 'í–‰');
                            resolve(jsonData);
                        } catch (error) {
                            console.error('âŒ ì—‘ì…€ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
                            reject(error);
                        }
                    };

                    reader.onerror = function(error) {
                        reject(error);
                    };

                    reader.readAsBinaryString(file);
                });
            },

            validateData: function(data) {
                if (!data || data.length < 2) {
                    throw new Error('ë°ì´í„°ê°€ ë¹„ì–´ìˆê±°ë‚˜ í—¤ë”ë§Œ ìˆìŠµë‹ˆë‹¤.');
                }

                const headers = data[0];
                const validation = {
                    isValid: true,
                    errors: [],
                    warnings: [],
                    summary: {
                        totalRows: data.length - 1,
                        totalColumns: headers.length,
                        missingValues: 0
                    }
                };

                this.config.requiredColumns.forEach(col => {
                    if (!headers.includes(col)) {
                        validation.errors.push(`í•„ìˆ˜ ì»¬ëŸ¼ '${col}' ëˆ„ë½`);
                        validation.isValid = false;
                    }
                });

                console.log('âœ… ë°ì´í„° ê²€ì¦ ì™„ë£Œ:', validation.summary);
                return validation;
            },

            parsePatientData: function(rawData) {
                const headers = rawData[0];
                const rows = rawData.slice(1);
                
                console.log('ğŸ“Š === í™˜ì ë°ì´í„° íŒŒì‹± ì‹œì‘ ===');
                
                const getColumnIndex = (columnName) => {
                    const index = headers.findIndex(header => 
                        header && header.toString().includes(columnName)
                    );
                    return index;
                };

                const indices = {
                    visitDate: getColumnIndex('ë‚´ì›ì¼ì'),
                    visitTime: getColumnIndex('ë‚´ì›ì‹œê°„'),
                    patientName: getColumnIndex('ì´ë¦„'),
                    gender: getColumnIndex('ì„±ë³„'),
                    age: getColumnIndex('ë‚˜ì´'),
                    doctor: getColumnIndex('ì‘ê¸‰ì‹¤ì˜ì‚¬'),
                    symptom: getColumnIndex('ì£¼ì¦ìƒ'),
                    ktas: getColumnIndex('KTAS'),
                    result: getColumnIndex('ì§„ë£Œê²°ê³¼ëª…'),
                    admissionDept: getColumnIndex('ì…ì›ê³¼'),
                    stayTime: getColumnIndex('ì²´ë¥˜ì‹œê°„'),
                    actualExitDate: getColumnIndex('ì‹¤ì œí‡´ì‹¤ì¼ì'),
                    actualExitTime: getColumnIndex('ì‹¤ì œí‡´ì‹¤ì‹œê°„')
                };

                const requiredFields = ['visitDate', 'visitTime', 'doctor'];
                const missingFields = requiredFields.filter(field => indices[field] === -1);
                
                if (missingFields.length > 0) {
                    throw new Error(`í•„ìˆ˜ ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤: ${missingFields.join(', ')}`);
                }

                const processedData = rows.map((row, index) => {
                    try {
                        let visitDate = row[indices.visitDate];
                        if (visitDate) {
                            visitDate = visitDate.toString();
                            if (visitDate.length === 8) {
                                visitDate = `${visitDate.substr(0,4)}-${visitDate.substr(4,2)}-${visitDate.substr(6,2)}`;
                            }
                        }

                        let visitTime = row[indices.visitTime];
                        if (visitTime) {
                            visitTime = visitTime.toString().padStart(4, '0');
                            visitTime = `${visitTime.substr(0,2)}:${visitTime.substr(2,2)}`;
                        }

                        let doctor = row[indices.doctor];
                        if (doctor) {
                            const originalDoctor = doctor.toString().trim();
                            doctor = originalDoctor;
                            const parenthesesIndex = doctor.indexOf('(');
                            if (parenthesesIndex !== -1) {
                                doctor = doctor.substring(0, parenthesesIndex).trim();
                            }
                        }

                        // ì²´ë¥˜ì‹œê°„ ê³„ì‚°
                        let stayMinutes = this.calculateStayMinutes(row, indices);
                        
                        // í‡´ì‹¤ì‹œê°„ ê³„ì‚°
                        let exitDateTime = null;
                        if (visitDate && visitTime && stayMinutes) {
                            const visitDateTime = new Date(`${visitDate} ${visitTime}:00`);
                            exitDateTime = new Date(visitDateTime.getTime() + stayMinutes * 60 * 1000);
                        }

                        const processedRow = {
                            rowIndex: index + 1,
                            visitDate: visitDate || 'Unknown',
                            visitTime: visitTime || 'Unknown',
                            visitDateTime: visitDate && visitTime ? new Date(`${visitDate} ${visitTime}:00`) : null,
                            exitDateTime: exitDateTime,
                            stayMinutes: stayMinutes,
                            stayHours: stayMinutes ? stayMinutes / 60 : null,
                            patientName: row[indices.patientName] || 'Unknown',
                            gender: row[indices.gender] || 'Unknown',
                            age: row[indices.age] || 'Unknown',
                            doctor: doctor || 'Unknown',
                            symptom: row[indices.symptom] || 'Unknown',
                            ktas: row[indices.ktas] || 'Unknown',
                            result: row[indices.result] || 'Unknown',
                            admissionDept: row[indices.admissionDept] || '',
                            timeCategory: this.categorizeTime(visitTime),
                            dayOfWeek: this.getDayOfWeek(visitDate),
                            hour: visitTime ? parseInt(visitTime.split(':')[0]) : null,
                            isValid: visitDate && visitTime && stayMinutes && stayMinutes > 0
                        };

                        return processedRow;
                    } catch (error) {
                        console.warn(`âš ï¸ í–‰ ${index + 1} ì²˜ë¦¬ ì˜¤ë¥˜:`, error);
                        return null;
                    }
                }).filter(item => item !== null);

                console.log(`âœ… ë°ì´í„° íŒŒì‹± ì™„ë£Œ: ${processedData.length}/${rows.length} í–‰ ì²˜ë¦¬ë¨`);
                return processedData;
            },

            // ì²´ë¥˜ì‹œê°„ ê³„ì‚°
            calculateStayMinutes: function(row, indices) {
                // 1ìˆœìœ„: 'ì²´ë¥˜ì‹œê°„' ì»¬ëŸ¼
                if (indices.stayTime !== -1 && row[indices.stayTime]) {
                    const stayMinutes = parseFloat(row[indices.stayTime]);
                    if (stayMinutes > 0 && stayMinutes < 1440) {
                        return stayMinutes;
                    }
                }
                
                // 2ìˆœìœ„: ì‹¤ì œí‡´ì‹¤ì¼ì/ì‹œê°„ - ë‚´ì›ì¼ì/ì‹œê°„
                if (indices.actualExitDate !== -1 && indices.actualExitTime !== -1 && 
                    row[indices.actualExitDate] && row[indices.actualExitTime]) {
                    try {
                        const visitDate = this.parseDate(row[indices.visitDate]);
                        const visitTime = this.parseTime(row[indices.visitTime]);
                        const exitDate = this.parseDate(row[indices.actualExitDate]);
                        const exitTime = this.parseTime(row[indices.actualExitTime]);
                        
                        if (visitDate && visitTime && exitDate && exitTime) {
                            const visitDateTime = new Date(`${visitDate} ${visitTime}:00`);
                            const exitDateTime = new Date(`${exitDate} ${exitTime}:00`);
                            
                            const diffMs = exitDateTime.getTime() - visitDateTime.getTime();
                            const diffMinutes = diffMs / (1000 * 60);
                            
                            if (diffMinutes > 0 && diffMinutes < 1440) {
                                return diffMinutes;
                            }
                        }
                    } catch (error) {
                        console.warn('í‡´ì‹¤ì‹œê°„ ê³„ì‚° ì˜¤ë¥˜:', error);
                    }
                }
                
                // 3ìˆœìœ„: ì¶”ì •
                return this.estimateStayTime();
            },

            // ì¶”ì • ì²´ë¥˜ì‹œê°„
            estimateStayTime: function() {
                const avgStayHours = 4.8;
                const randomFactor = 0.7 + (Math.random() * 0.6);
                const estimatedHours = avgStayHours * randomFactor;
                return Math.round(estimatedHours * 60);
            },

            // ë‚ ì§œ íŒŒì‹±
            parseDate: function(dateValue) {
                if (!dateValue) return null;
                
                const dateStr = dateValue.toString();
                if (dateStr.length === 8) {
                    return `${dateStr.substr(0,4)}-${dateStr.substr(4,2)}-${dateStr.substr(6,2)}`;
                } else if (dateStr.includes('-')) {
                    return dateStr;
                }
                return null;
            },

            // ì‹œê°„ íŒŒì‹±
            parseTime: function(timeValue) {
                if (!timeValue) return null;
                
                const timeStr = timeValue.toString().padStart(4, '0');
                if (timeStr.length === 4) {
                    return `${timeStr.substr(0,2)}:${timeStr.substr(2,2)}`;
                } else if (timeStr.includes(':')) {
                    return timeStr;
                }
                return null;
            },

            categorizeTime: function(timeString) {
                if (!timeString || timeString === 'Unknown') return 'Unknown';
                
                const hour = parseInt(timeString.split(':')[0]);
                
                if (hour >= 8 && hour < 18) return 'D';
                else if (hour >= 18 || hour < 8) return 'N';
                else return 'Unknown';
            },

            getDayOfWeek: function(dateString) {
                if (!dateString || dateString === 'Unknown') return 'Unknown';
                
                try {
                    const date = new Date(dateString);
                    const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                    return days[date.getDay()];
                } catch (error) {
                    return 'Unknown';
                }
            },

            generateSummaryStats: function(data) {
                const stats = {
                    totalPatients: data.length,
                    dateRange: {
                        start: null,
                        end: null
                    },
                    doctorStats: {},
                    timeStats: {},
                    dailyStats: {},
                    avgPatientsPerDay: 0
                };

                const validDates = data
                    .map(item => item.visitDate)
                    .filter(date => date !== 'Unknown')
                    .sort();
                
                if (validDates.length > 0) {
                    stats.dateRange.start = validDates[0];
                    stats.dateRange.end = validDates[validDates.length - 1];
                }

                data.forEach(item => {
                    if (item.doctor !== 'Unknown') {
                        stats.doctorStats[item.doctor] = (stats.doctorStats[item.doctor] || 0) + 1;
                    }

                    stats.timeStats[item.timeCategory] = (stats.timeStats[item.timeCategory] || 0) + 1;

                    if (item.visitDate !== 'Unknown') {
                        stats.dailyStats[item.visitDate] = (stats.dailyStats[item.visitDate] || 0) + 1;
                    }
                });

                const totalDays = Object.keys(stats.dailyStats).length;
                if (totalDays > 0) {
                    stats.avgPatientsPerDay = Math.round(stats.totalPatients / totalDays);
                }

                console.log('ğŸ“Š í†µê³„ ë¶„ì„ ì™„ë£Œ:', stats);
                return stats;
            }
        };

        /* ========================================
           ğŸ“¦ MODULE: ë°ëª¨ ë°ì´í„° ìƒì„±ê¸°
           ======================================== */
        const DemoDataGenerator = {
            generateDemoData: function() {
                console.log('ğŸ­ ë°ëª¨ ë°ì´í„° ìƒì„± ì‹œì‘...');
                
                const doctors = ['ê¹€ì‘ê¸‰', 'ë°•ì™¸ìƒ', 'ì´ë‚´ê³¼', 'ìµœì†Œì•„', 'ì •ì‹ ê²½'];
                const symptoms = ['ë³µí†µ', 'í‰í†µ', 'ë‘í†µ', 'í˜¸í¡ê³¤ë€', 'ì™¸ìƒ', 'ë°œì—´', 'ì–´ì§€ëŸ¬ì›€'];
                const ktasLevels = [1, 2, 3, 4, 5];
                const results = ['ê·€ê°€', 'ì…ì›', 'ì „ì›', 'ì‚¬ë§', 'ìì˜í‡´ì›'];
                const departments = ['ë‚´ê³¼', 'ì™¸ê³¼', 'ì •í˜•ì™¸ê³¼', 'ì‹ ê²½ì™¸ê³¼', 'ì†Œì•„ê³¼', 'ì‚°ë¶€ì¸ê³¼'];
                
                const demoPatients = [];
                const baseDate = new Date('2024-06-01');
                
                // 30ì¼ê°„ ë°ì´í„° ìƒì„±
                for (let day = 0; day < 30; day++) {
                    const currentDate = new Date(baseDate);
                    currentDate.setDate(baseDate.getDate() + day);
                    const dateStr = currentDate.toISOString().split('T')[0];
                    
                    // í•˜ë£¨ì— 30-80ëª…ì˜ í™˜ì (ìš”ì¼ë³„ ë³€ë™)
                    const dayOfWeek = currentDate.getDay();
                    let basePatients = 50;
                    if (dayOfWeek === 0 || dayOfWeek === 6) basePatients += 15; // ì£¼ë§ ì¦ê°€
                    
                    const dailyPatients = basePatients + Math.floor(Math.random() * 30);
                    
                    for (let p = 0; p < dailyPatients; p++) {
                        // ì‹œê°„ë³„ ë¶„í¬ (ë°¤ê³¼ ì €ë…ì— ë” ë§ìŒ)
                        let hour;
                        const timeRandom = Math.random();
                        if (timeRandom < 0.3) hour = Math.floor(Math.random() * 8) + 18; // 18-01ì‹œ (30%)
                        else if (timeRandom < 0.5) hour = Math.floor(Math.random() * 6) + 6; // 06-11ì‹œ (20%)
                        else hour = Math.floor(Math.random() * 24); // ì „ì²´ ì‹œê°„ (50%)
                        
                        if (hour >= 24) hour -= 24;
                        
                        const minute = Math.floor(Math.random() * 60);
                        const visitTime = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        
                        // ì²´ë¥˜ì‹œê°„ (1-12ì‹œê°„, ëŒ€ë¶€ë¶„ 2-6ì‹œê°„)
                        const stayHours = 2 + Math.random() * 4 + (Math.random() < 0.2 ? Math.random() * 6 : 0);
                        const stayMinutes = Math.round(stayHours * 60);
                        
                        // í‡´ì‹¤ì‹œê°„ ê³„ì‚°
                        const visitDateTime = new Date(`${dateStr} ${visitTime}:00`);
                        const exitDateTime = new Date(visitDateTime.getTime() + stayMinutes * 60 * 1000);
                        
                        const patient = {
                            rowIndex: p + 1,
                            visitDate: dateStr,
                            visitTime: visitTime,
                            visitDateTime: visitDateTime,
                            exitDateTime: exitDateTime,
                            stayMinutes: stayMinutes,
                            stayHours: stayHours,
                            patientName: `í™˜ì${day * 100 + p + 1}`,
                            gender: Math.random() > 0.5 ? 'ë‚¨' : 'ì—¬',
                            age: Math.floor(Math.random() * 80) + 10,
                            doctor: doctors[Math.floor(Math.random() * doctors.length)],
                            symptom: symptoms[Math.floor(Math.random() * symptoms.length)],
                            ktas: ktasLevels[Math.floor(Math.random() * ktasLevels.length)],
                            result: results[Math.floor(Math.random() * results.length)],
                            admissionDept: Math.random() > 0.7 ? departments[Math.floor(Math.random() * departments.length)] : '',
                            timeCategory: hour >= 8 && hour < 18 ? 'D' : 'N',
                            dayOfWeek: ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][dayOfWeek],
                            hour: hour,
                            isValid: true
                        };
                        
                        demoPatients.push(patient);
                    }
                }
                
                console.log(`âœ… ë°ëª¨ ë°ì´í„° ìƒì„± ì™„ë£Œ: ${demoPatients.length}ëª… í™˜ì`);
                return demoPatients;
            }
        };

        /* ========================================
           ğŸ“¦ MODULE: ì‹¤ì‹œê°„ ì¬ì‹¤í™˜ììˆ˜ ê³„ì‚°ê¸° (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
           ======================================== */
        const RealtimeOccupancyCalculator = {
            calculateRealtimeOccupancy: function(patients, config = {}) {
                console.log('ğŸ¥ === ì‹¤ì‹œê°„ ë¶„ë‹¹ ì¬ì‹¤í™˜ììˆ˜ ê³„ì‚° ===');
                
                const maxOccupancy = config.maxOccupancy || 35;
                
                const validPatients = patients.filter(p => p.isValid);
                console.log(`ğŸ“Š ìœ íš¨í•œ í™˜ì: ${validPatients.length}ëª…`);
                
                const dateGroups = {};
                validPatients.forEach(patient => {
                    const date = patient.visitDate;
                    if (!dateGroups[date]) {
                        dateGroups[date] = [];
                    }
                    dateGroups[date].push(patient);
                });
                
                const dates = Object.keys(dateGroups).sort();
                console.log(`ğŸ“… ë¶„ì„ ë‚ ì§œ: ${dates.length}ì¼`);
                
                const occupancyByDate = {};
                let totalAdjustedPoints = 0;
                
                dates.forEach(date => {
                    const dayResult = this.calculateDayOccupancy(dateGroups[date], date, maxOccupancy);
                    occupancyByDate[date] = dayResult.occupancy;
                    totalAdjustedPoints += dayResult.adjustedPoints;
                });
                
                const minuteAverages = [];
                for (let minute = 0; minute < 1440; minute++) {
                    const occupancyValues = dates.map(date => occupancyByDate[date][minute]);
                    const average = occupancyValues.reduce((sum, val) => sum + val, 0) / dates.length;
                    minuteAverages.push(Math.round(average * 10) / 10);
                }
                
                const statistics = this.calculateStatistics(minuteAverages, validPatients, dates);
                
                console.log(`ğŸ“Š ì‹¤ì‹œê°„ ì¬ì‹¤í™˜ììˆ˜ ê²°ê³¼:`);
                console.log(`   ìµœëŒ€: ${statistics.max}ëª…`);
                console.log(`   ìµœì†Œ: ${statistics.min}ëª…`);
                console.log(`   í‰ê· : ${statistics.average}ëª…`);
                
                return {
                    minuteData: minuteAverages,
                    statistics: statistics,
                    metadata: {
                        totalDays: dates.length,
                        totalPatients: validPatients.length,
                        dailyAverage: validPatients.length / dates.length,
                        adjustedPoints: totalAdjustedPoints,
                        dateRange: `${dates[0]} ~ ${dates[dates.length-1]}`
                    }
                };
            },

            calculateDayOccupancy: function(patients, date, maxOccupancy) {
                const occupancy = new Array(1440).fill(0);
                let adjustedPoints = 0;
                
                const dayStart = new Date(`${date} 00:00:00`);
                const dayEnd = new Date(`${date} 23:59:59`);
                
                const relevantPatients = patients.filter(patient => {
                    return patient.visitDateTime <= dayEnd && patient.exitDateTime > dayStart;
                });
                
                for (let minute = 0; minute < 1440; minute++) {
                    const currentTime = new Date(dayStart.getTime() + minute * 60 * 1000);
                    
                    let count = 0;
                    relevantPatients.forEach(patient => {
                        if (patient.visitDateTime <= currentTime && currentTime < patient.exitDateTime) {
                            count++;
                        }
                    });
                    
                    if (count > maxOccupancy) {
                        count = maxOccupancy;
                        adjustedPoints++;
                    }
                    
                    occupancy[minute] = count;
                }
                
                return {
                    occupancy: occupancy,
                    adjustedPoints: adjustedPoints
                };
            },

            calculateStatistics: function(minuteData, patients, dates) {
                const max = Math.max(...minuteData);
                const min = Math.min(...minuteData);
                const maxIndex = minuteData.indexOf(max);
                const average = minuteData.reduce((sum, val) => sum + val, 0) / 1440;
                
                const hourlySummary = [];
                for (let hour = 0; hour < 24; hour++) {
                    const hourData = minuteData.slice(hour * 60, (hour + 1) * 60);
                    const hourAvg = hourData.reduce((sum, val) => sum + val, 0) / 60;
                    hourlySummary.push(Math.round(hourAvg * 10) / 10);
                }
                
                return {
                    max: max,
                    min: min,
                    maxIndex: maxIndex,
                    average: Math.round(average * 10) / 10,
                    peakTime: `${Math.floor(maxIndex/60).toString().padStart(2, '0')}:${(maxIndex%60).toString().padStart(2, '0')}`,
                    hourlySummary: hourlySummary,
                    totalDays: dates.length,
                    totalPatients: patients.length
                };
            }
        };

        /* ========================================
           ğŸ“¦ MODULE: ì°¨íŠ¸ ìƒì„±ê¸° (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
           ======================================== */
        const ChartGenerator = {
            getCommonOptions: function(title, showDataLabels = false) {
                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            font: {
                                size: 18,
                                weight: '600'
                            },
                            color: '#1e293b',
                            padding: 20
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12,
                                    weight: '500'
                                },
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0,
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: '#e2e8f0'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: '#e2e8f0'
                            }
                        }
                    }
                };

                if (showDataLabels) {
                    options.plugins.datalabels = {
                        anchor: 'end',
                        align: 'top',
                        font: {
                            weight: '600',
                            size: 11
                        },
                        color: '#1e293b',
                        formatter: function(value, context) {
                            return value;
                        }
                    };
                }

                return options;
            },

            getPieChartOptions: function(title) {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            font: {
                                size: 18,
                                weight: '600'
                            },
                            color: '#1e293b',
                            padding: 20
                        },
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12,
                                    weight: '500'
                                },
                                padding: 15,
                                usePointStyle: true,
                                boxWidth: 15
                            }
                        },
                        datalabels: {
                            formatter: (value, ctx) => {
                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return percentage >= 5 ? `${value}` : '';
                            },
                            color: '#ffffff',
                            font: {
                                weight: 'bold',
                                size: 12
                            },
                            textStrokeColor: '#1e293b',
                            textStrokeWidth: 1
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((context.parsed / total) * 100);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                };
            },

            createChartContainer: function(id, title) {
                return `
                    <div class="chart-container" id="${id}Container">
                        <div class="chart-header">
                            <h5><i class="fas fa-chart-bar"></i> ${title}</h5>
                        </div>
                        <div style="height: 400px;">
                            <canvas id="${id}"></canvas>
                        </div>
                    </div>
                `;
            },

            getAcademicColorPalette: function(count) {
                const colors = [
                    '#2563eb', '#dc2626', '#059669', '#d97706',
                    '#7c3aed', '#0891b2', '#4f46e5', '#ea580c',
                    '#65a30d', '#c2410c', '#7e22ce', '#0e7490'
                ];
                return colors.slice(0, count);
            }
        };

        /* ========================================
           ğŸ“¦ MODULE: ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
           ======================================== */
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ í†µí•©ëœ ì‘ê¸‰ì‹¤ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ì‹œì‘ (ë°ì´í„° ê³µìœ  ë²„ì „)');
            initializeSystem();
        });

        function initializeSystem() {
            // ì €ì¥ëœ ë°ì´í„° í™•ì¸ ë° ë¡œë“œ
            const savedData = StorageManager.loadData();
            
            if (savedData) {
                // ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë°”ë¡œ í‘œì‹œ
                console.log('ğŸ’¾ ì €ì¥ëœ ë°ì´í„° ë°œê²¬, ìë™ ë¡œë“œ ì¤‘...');
                
                patientData = savedData.patientData;
                analysisResults = savedData.analysisResults;
                realtimeOccupancyData = savedData.realtimeData;
                
                const isDemo = savedData.dataSource === 'demo';
                
                // UI ì—…ë°ì´íŠ¸
                UIStateManager.updateSharingStatus(true, isDemo, savedData.dataSource);
                UIStateManager.switchMode('user');
                displayAnalysisResults();
                
                // ë°ì´í„° ì†ŒìŠ¤ í‘œì‹œ (ê°„ì†Œí™”)
                document.getElementById('currentDatasetName').textContent = 
                    isDemo ? 'ë°ëª¨ ë°ì´í„°' : `ì—…ë¡œë“œ ë°ì´í„° (${new Date(savedData.lastUpload).toLocaleDateString()})`;
                
            } else {
                // ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì—…ë¡œë“œ ëª¨ë“œ
                console.log('ğŸ“­ ì €ì¥ëœ ë°ì´í„° ì—†ìŒ, ì—…ë¡œë“œ ëª¨ë“œë¡œ ì‹œì‘');
                UIStateManager.updateSharingStatus(false);
                UIStateManager.switchMode('uploader');
            }
            
            // íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥ ì´ˆê¸°í™”
            initializeFileUpload();
        }

        function initializeFileUpload() {
            const fileInput = document.getElementById('patientFileInput');
            const dropArea = document.getElementById('fileDropArea');

            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });

            dropArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                if (!dropArea.classList.contains('disabled')) {
                    dropArea.classList.add('drag-over');
                }
            });

            dropArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropArea.classList.remove('drag-over');
            });

            dropArea.addEventListener('drop', function(e) {
                e.preventDefault();
                dropArea.classList.remove('drag-over');
                
                if (!dropArea.classList.contains('disabled') && e.dataTransfer.files.length > 0) {
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });

            dropArea.addEventListener('click', function() {
                if (!dropArea.classList.contains('disabled')) {
                    fileInput.click();
                }
            });
        }

        /* ========================================
           ğŸ“¦ MODULE: íŒŒì¼ ì—…ë¡œë“œ ë° ë°ì´í„° ì²˜ë¦¬
           ======================================== */
        async function handleFileUpload(file) {
            console.log('ğŸ“ íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘:', file.name);
            
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('ì—‘ì…€ íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            showLoading(true);
            updateLoadingProgress('íŒŒì¼ ì½ëŠ” ì¤‘...', 25);

            try {
                const rawData = await PatientAnalyzer.readExcelFile(file);
                updateLoadingProgress('ë°ì´í„° ê²€ì¦ ì¤‘...', 50);

                const validation = PatientAnalyzer.validateData(rawData);
                if (!validation.isValid) {
                    throw new Error('ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨: ' + validation.errors.join(', '));
                }

                updateLoadingProgress('ë°ì´í„° íŒŒì‹± ì¤‘...', 75);

                patientData = PatientAnalyzer.parsePatientData(rawData);
                updateLoadingProgress('í†µê³„ ë¶„ì„ ì¤‘...', 90);

                analysisResults = PatientAnalyzer.generateSummaryStats(patientData);
                updateLoadingProgress('ë°ì´í„° ì €ì¥ ì¤‘...', 95);

                // ë°ì´í„° ì €ì¥
                const saveSuccess = StorageManager.saveData(patientData, analysisResults, null, 'upload');
                if (!saveSuccess) {
                    console.warn('âš ï¸ ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆì§€ë§Œ ë¶„ì„ì€ ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤.');
                }

                updateLoadingProgress('ì™„ë£Œ!', 100);

                setTimeout(() => {
                    showLoading(false);
                    displayAnalysisResults();
                    
                    // UI ìƒíƒœ ì—…ë°ì´íŠ¸
                    UIStateManager.updateSharingStatus(true, false, 'upload');
                    UIStateManager.switchMode('user');
                    
                    // ë°ì´í„° ì†ŒìŠ¤ í‘œì‹œ (ê°„ì†Œí™”)
                    const fileName = file.name.replace(/\.(xlsx|xls)$/i, '');
                    document.getElementById('currentDatasetName').textContent = fileName;
                    
                    // ì„±ê³µ ë©”ì‹œì§€
                    alert('âœ… ë°ì´í„° ì—…ë¡œë“œ ë° ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    
                }, 1000);

            } catch (error) {
                console.error('âŒ íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                showLoading(false);
                alert('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        /* ========================================
           ğŸ“¦ MODULE: ë°ëª¨ ë°ì´í„° ë¡œë“œ
           ======================================== */
        function loadDemoData() {
            console.log('ğŸ­ ë°ëª¨ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
            
            showLoading(true);
            updateLoadingProgress('ë°ëª¨ ë°ì´í„° ìƒì„± ì¤‘...', 25);
            
            setTimeout(() => {
                try {
                    updateLoadingProgress('í™˜ì ë°ì´í„° ìƒì„± ì¤‘...', 50);
                    
                    // ë°ëª¨ ë°ì´í„° ìƒì„±
                    patientData = DemoDataGenerator.generateDemoData();
                    
                    updateLoadingProgress('í†µê³„ ë¶„ì„ ì¤‘...', 75);
                    
                    // ë¶„ì„ ê²°ê³¼ ìƒì„±
                    analysisResults = PatientAnalyzer.generateSummaryStats(patientData);
                    
                    updateLoadingProgress('ë°ëª¨ ë°ì´í„° ì €ì¥ ì¤‘...', 90);
                    
                    // ë°ëª¨ ë°ì´í„° ì €ì¥
                    StorageManager.saveData(patientData, analysisResults, null, 'demo');
                    
                    updateLoadingProgress('ì™„ë£Œ!', 100);
                    
                    setTimeout(() => {
                        showLoading(false);
                        displayAnalysisResults();
                        
                        // UI ìƒíƒœ ì—…ë°ì´íŠ¸
                        UIStateManager.updateSharingStatus(true, true, 'demo');
                        UIStateManager.switchMode('user');
                        
                        // ë°ì´í„° ì†ŒìŠ¤ í‘œì‹œ (ê°„ì†Œí™”)
                        document.getElementById('currentDatasetName').textContent = 'ë°ëª¨ ë°ì´í„°';
                        
                        console.log('âœ… ë°ëª¨ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                        
                    }, 1000);
                    
                } catch (error) {
                    console.error('âŒ ë°ëª¨ ë°ì´í„° ìƒì„± ì˜¤ë¥˜:', error);
                    showLoading(false);
                    alert('ë°ëª¨ ë°ì´í„° ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }, 500);
        }

        /* ========================================
           ğŸ“¦ MODULE: UI ì»¨íŠ¸ë¡¤ í•¨ìˆ˜ë“¤
           ======================================== */
        function switchToUploaderMode() {
            UIStateManager.switchMode('uploader');
        }

        function clearStoredData() {
            if (confirm('ì €ì¥ëœ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œí•˜ë©´ ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ë„ ë” ì´ìƒ ì´ ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                const success = StorageManager.clearData();
                if (success) {
                    // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
                    patientData = null;
                    analysisResults = null;
                    realtimeOccupancyData = null;
                    generatedCharts = {};
                    
                    // UI ì´ˆê¸°í™”
                    document.getElementById('analysisResults').style.display = 'none';
                    document.getElementById('step2Module').style.display = 'none';
                    document.getElementById('chartsContainer').innerHTML = '';
                    
                    // ìƒíƒœ ì—…ë°ì´íŠ¸
                    UIStateManager.updateSharingStatus(false);
                    UIStateManager.switchMode('uploader');
                    
                    alert('âœ… ì €ì¥ëœ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('âŒ ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        function showLoading(show) {
            const loadingSpinner = document.getElementById('loadingSpinner');
            const analysisResults = document.getElementById('analysisResults');
            
            if (show) {
                loadingSpinner.style.display = 'block';
                analysisResults.style.display = 'none';
            } else {
                loadingSpinner.style.display = 'none';
            }
        }

        function updateLoadingProgress(message, percentage) {
            const progressDiv = document.getElementById('loadingProgress');
            progressDiv.innerHTML = `
                <div class="progress progress-academic mb-3" style="height: 8px;">
                    <div class="progress-bar progress-bar-academic" style="width: ${percentage}%"></div>
                </div>
                <p class="text-muted mb-0">${message} (${percentage}%)</p>
            `;
        }

        function displayAnalysisResults() {
            if (!analysisResults || !patientData) {
                console.error('âŒ ë¶„ì„ ê²°ê³¼ ë˜ëŠ” í™˜ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            document.getElementById('totalPatients').textContent = analysisResults.totalPatients.toLocaleString();
            document.getElementById('totalDoctors').textContent = Object.keys(analysisResults.doctorStats).length;
            document.getElementById('avgPatientsPerDay').textContent = analysisResults.avgPatientsPerDay;
            
            if (analysisResults.dateRange.start && analysisResults.dateRange.end) {
                const startDate = new Date(analysisResults.dateRange.start);
                const endDate = new Date(analysisResults.dateRange.end);
                document.getElementById('dateRange').textContent = 
                    `${startDate.getMonth()+1}/${startDate.getDate()} - ${endDate.getMonth()+1}/${endDate.getDate()}`;
            }

            document.getElementById('analysisResults').style.display = 'block';
        }

        function goToStep2() {
            if (!patientData || !analysisResults) {
                alert('ë¨¼ì € í™˜ì ë°ì´í„°ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.');
                return;
            }

            document.getElementById('step2Module').style.display = 'block';
            document.getElementById('step2Module').scrollIntoView({ behavior: 'smooth' });
        }

        /* ========================================
           ğŸ“¦ MODULE: ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜ë“¤ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
           ======================================== */

        // 1. ì¼ë³„ í™˜ììˆ˜ ê·¸ë˜í”„
        function generateDailyPatientChart() {
            console.log('ğŸ“Š ì¼ë³„ í™˜ììˆ˜ ì°¨íŠ¸ ìƒì„± ì‹œì‘...');
            
            if (!patientData || !analysisResults) {
                throw new Error('í™˜ì ë°ì´í„° ë˜ëŠ” ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }

            const dailyStats = {};
            patientData.forEach(patient => {
                if (patient.visitDate !== 'Unknown') {
                    const date = patient.visitDate;
                    dailyStats[date] = (dailyStats[date] || 0) + 1;
                }
            });

            const sortedDates = Object.keys(dailyStats).sort();
            const patientCounts = sortedDates.map(date => dailyStats[date]);

            if (sortedDates.length === 0) {
                throw new Error('ìœ íš¨í•œ ë‚ ì§œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }

            const chartHtml = ChartGenerator.createChartContainer('dailyChart', 'ì¼ë³„ í™˜ììˆ˜ ë¶„ì„');
            const container = document.getElementById('chartsContainer');
            container.insertAdjacentHTML('afterbegin', chartHtml);

            const ctx = document.getElementById('dailyChart').getContext('2d');
            generatedCharts.dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates.map(date => {
                        const d = new Date(date);
                        return `${d.getMonth() + 1}/${d.getDate()}`;
                    }),
                    datasets: [{
                        label: 'ì¼ë³„ í™˜ììˆ˜',
                        data: patientCounts,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#2563eb',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    ...ChartGenerator.getCommonOptions('ì¼ë³„ í™˜ììˆ˜ ì¶”ì´'),
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'í™˜ììˆ˜ (ëª…)',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ë‚ ì§œ',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        }
                    }
                }
            });
            
            console.log('âœ… ì¼ë³„ í™˜ììˆ˜ ì°¨íŠ¸ ìƒì„± ì™„ë£Œ');
        }

        // 2. ìš”ì¼ë³„ í‰ê· í™˜ììˆ˜ ê·¸ë˜í”„
        function generateWeeklyAverageChart() {
            console.log('ğŸ“Š ìš”ì¼ë³„ í‰ê· í™˜ììˆ˜ ì°¨íŠ¸ ìƒì„± ì‹œì‘...');
            
            if (!patientData || !analysisResults) {
                throw new Error('í™˜ì ë°ì´í„° ë˜ëŠ” ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }

            const weeklyStats = {};
            const weeklyCount = {};
            const dayOrder = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];

            patientData.forEach(patient => {
                if (patient.dayOfWeek !== 'Unknown') {
                    const day = patient.dayOfWeek;
                    weeklyStats[day] = (weeklyStats[day] || 0) + 1;
                }
            });

            const dailyCount = {};
            patientData.forEach(patient => {
                if (patient.visitDate !== 'Unknown' && patient.dayOfWeek !== 'Unknown') {
                    const key = `${patient.visitDate}_${patient.dayOfWeek}`;
                    if (!dailyCount[key]) {
                        weeklyCount[patient.dayOfWeek] = (weeklyCount[patient.dayOfWeek] || 0) + 1;
                        dailyCount[key] = true;
                    }
                }
            });

            const averages = dayOrder.map(day => {
                const total = weeklyStats[day] || 0;
                const days = weeklyCount[day] || 1;
                return Math.round(total / days * 10) / 10;
            });

            const chartHtml = ChartGenerator.createChartContainer('weeklyChart', 'ìš”ì¼ë³„ í‰ê· í™˜ììˆ˜ ë¶„ì„');
            const container = document.getElementById('chartsContainer');
            container.insertAdjacentHTML('afterbegin', chartHtml);

            const ctx = document.getElementById('weeklyChart').getContext('2d');
            generatedCharts.weeklyChart = new Chart(ctx, {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: {
                    labels: dayOrder,
                    datasets: [{
                        label: 'í‰ê·  í™˜ììˆ˜',
                        data: averages,
                        backgroundColor: ChartGenerator.getAcademicColorPalette(7),
                        borderColor: '#1e293b',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    ...ChartGenerator.getCommonOptions('ìš”ì¼ë³„ í‰ê·  í™˜ììˆ˜', true),
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'í‰ê·  í™˜ììˆ˜ (ëª…)',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ìš”ì¼',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        }
                    }
                }
            });
            
            console.log('âœ… ìš”ì¼ë³„ í‰ê· í™˜ììˆ˜ ì°¨íŠ¸ ìƒì„± ì™„ë£Œ');
        }

        // 3. ì‹œê°„ëŒ€ë³„ ë‚´ì›í™˜ììˆ˜ ê·¸ë˜í”„
        function generateHourlyAverageChart() {
            if (!patientData) {
                alert('ë¨¼ì € í™˜ì ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }

            const hourlyStats = {};
            for (let i = 0; i < 24; i++) {
                hourlyStats[i] = 0;
            }

            patientData.forEach(patient => {
                if (patient.hour !== null) {
                    hourlyStats[patient.hour]++;
                }
            });

            const totalDays = Object.keys(analysisResults.dailyStats).length || 1;
            
            const hourlyAverages = [];
            const labels = [];
            for (let i = 0; i < 24; i++) {
                hourlyAverages.push(Math.round(hourlyStats[i] / totalDays * 10) / 10);
                labels.push(`${i.toString().padStart(2, '0')}:00`);
            }

            const chartHtml = ChartGenerator.createChartContainer('hourlyChart', 'ì‹œê°„ëŒ€ë³„ ë‚´ì›í™˜ììˆ˜ ë¶„ì„');
            const container = document.getElementById('chartsContainer');
            container.insertAdjacentHTML('afterbegin', chartHtml);

            const ctx = document.getElementById('hourlyChart').getContext('2d');
            generatedCharts.hourlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'í‰ê·  ë‚´ì›í™˜ììˆ˜',
                        data: hourlyAverages,
                        borderColor: '#059669',
                        backgroundColor: 'rgba(5, 150, 105, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        pointBackgroundColor: '#059669',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    ...ChartGenerator.getCommonOptions('ì‹œê°„ëŒ€ë³„ í‰ê·  ë‚´ì›í™˜ììˆ˜'),
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'í‰ê·  ë‚´ì›í™˜ììˆ˜ (ëª…)',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ì‹œê°„',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        }
                    }
                }
            });
        }

        // 4. ì‹¤ì‹œê°„ ë¶„ë‹¹ ì¬ì‹¤í™˜ììˆ˜ ê·¸ë˜í”„
        function generateRealtimeOccupancyChart() {
            console.log('ğŸ¥ ì‹¤ì‹œê°„ ë¶„ë‹¹ ì¬ì‹¤í™˜ììˆ˜ ì°¨íŠ¸ ìƒì„± ì‹œì‘...');
            
            if (!patientData) {
                alert('ë¨¼ì € í™˜ì ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const result = RealtimeOccupancyCalculator.calculateRealtimeOccupancy(patientData, {
                    maxOccupancy: 35
                });
                
                realtimeOccupancyData = result;
                
                // ì‹œê°„ëŒ€ë³„ í‰ê·  ë° ìµœëŒ€ê°’ ê³„ì‚°
                const hourlyAverages = [];
                const hourlyMaximums = [];
                const labels = [];
                
                for (let hour = 0; hour < 24; hour++) {
                    const hourStart = hour * 60;
                    const hourEnd = (hour + 1) * 60;
                    
                    let hourSum = 0;
                    let hourMax = 0;
                    for (let minute = hourStart; minute < hourEnd; minute++) {
                        hourSum += result.minuteData[minute];
                        hourMax = Math.max(hourMax, result.minuteData[minute]);
                    }
                    const hourlyAvg = hourSum / 60;
                    
                    hourlyAverages.push(Math.round(hourlyAvg * 10) / 10);
                    hourlyMaximums.push(Math.round(hourMax * 10) / 10);
                    labels.push(`${hour.toString().padStart(2, '0')}:00`);
                }

                const chartHtml = ChartGenerator.createChartContainer('realtimeOccupancyChart', 'ì‹¤ì‹œê°„ ë¶„ë‹¹ ì¬ì‹¤í™˜ììˆ˜ ë¶„ì„');
                const container = document.getElementById('chartsContainer');
                container.insertAdjacentHTML('afterbegin', chartHtml);

                const ctx = document.getElementById('realtimeOccupancyChart').getContext('2d');
                
                generatedCharts.realtimeOccupancyChart = new Chart(ctx, {
                    type: 'line',
                    plugins: [ChartDataLabels],
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ì‹œê°„ëŒ€ë³„ í‰ê· ',
                            data: hourlyAverages,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        }, {
                            label: 'ì‹œê°„ëŒ€ë³„ ìµœëŒ€ê°’',
                            data: hourlyMaximums,
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: '+1',
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: '#dc2626',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `ì‹¤ì‹œê°„ ë¶„ë‹¹ ì¬ì‹¤í™˜ììˆ˜ (ìµœëŒ€: ${result.statistics.max}ëª…, í‰ê· : ${result.statistics.average}ëª…)`,
                                font: { size: 18, weight: '600' },
                                color: '#1e293b',
                                padding: 20
                            },
                            legend: {
                                position: 'top',
                                labels: {
                                    font: { size: 12, weight: '500' },
                                    padding: 15,
                                    usePointStyle: true
                                }
                            },
                            datalabels: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const datasetLabel = context.dataset.label;
                                        return `${datasetLabel}: ${context.parsed.y}ëª…`;
                                    },
                                    afterLabel: function(context) {
                                        const hour = context.dataIndex;
                                        if (context.datasetIndex === 1) {
                                            return `${hour}:00~${hour+1}:00 ì¤‘ ë¶„ë‹¹ ìµœëŒ€ê°’`;
                                        } else {
                                            return `${hour}:00~${hour+1}:00 ë¶„ë‹¹ í‰ê· \n${result.metadata.totalDays}ì¼ê°„ ì‹¤ì‹œê°„ ê³„ì‚°`;
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: Math.min(50, Math.max(30, result.statistics.max + 5)),
                                title: {
                                    display: true,
                                    text: 'ì¬ì‹¤í™˜ììˆ˜ (ëª…)',
                                    font: { size: 12, weight: '600' }
                                },
                                grid: { color: '#e2e8f0' },
                                ticks: { 
                                    font: { size: 11 },
                                    precision: 1
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'ì‹œê°„ëŒ€',
                                    font: { size: 12, weight: '600' }
                                },
                                grid: { color: '#e2e8f0' },
                                ticks: { font: { size: 11 } }
                            }
                        }
                    }
                });
                
                console.log('âœ… ì‹¤ì‹œê°„ ë¶„ë‹¹ ì¬ì‹¤í™˜ììˆ˜ ì°¨íŠ¸ ìƒì„± ì™„ë£Œ!');
                
            } catch (error) {
                console.error('âŒ ì‹¤ì‹œê°„ ì¬ì‹¤í™˜ììˆ˜ ì°¨íŠ¸ ìƒì„± ì˜¤ë¥˜:', error);
                alert('ì‹¤ì‹œê°„ ì¬ì‹¤í™˜ììˆ˜ ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // 5. KTASë³„ í™˜ì ë¶„í¬
        function generateKTASDistributionChart() {
            if (!patientData) {
                alert('ë¨¼ì € í™˜ì ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }

            const ktasStats = {};
            patientData.forEach(patient => {
                const ktas = patient.ktas || 'Unknown';
                ktasStats[ktas] = (ktasStats[ktas] || 0) + 1;
            });

            const ktasLabels = Object.keys(ktasStats).sort();
            const ktasCounts = ktasLabels.map(ktas => ktasStats[ktas]);

            const chartHtml = ChartGenerator.createChartContainer('ktasChart', 'KTASë³„ í™˜ì ë¶„í¬');
            const container = document.getElementById('chartsContainer');
            container.insertAdjacentHTML('afterbegin', chartHtml);

            const ctx = document.getElementById('ktasChart').getContext('2d');
            generatedCharts.ktasChart = new Chart(ctx, {
                type: 'doughnut',
                plugins: [ChartDataLabels],
                data: {
                    labels: ktasLabels,
                    datasets: [{
                        label: 'í™˜ììˆ˜',
                        data: ktasCounts,
                        backgroundColor: ChartGenerator.getAcademicColorPalette(ktasLabels.length),
                        borderWidth: 3,
                        borderColor: '#ffffff'
                    }]
                },
                options: ChartGenerator.getPieChartOptions('KTASë³„ í™˜ì ë¶„í¬')
            });
        }

        // 6. ì…ì› VS ê·€ê°€ ë¶„ì„
        function generateAdmissionVsDischargeChart() {
            if (!patientData) {
                alert('ë¨¼ì € í™˜ì ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }

            const resultStats = {};
            patientData.forEach(patient => {
                const result = patient.result || 'Unknown';
                resultStats[result] = (resultStats[result] || 0) + 1;
            });

            const resultLabels = Object.keys(resultStats);
            const resultCounts = resultLabels.map(result => resultStats[result]);

            const chartHtml = ChartGenerator.createChartContainer('resultChart', 'ì…ì› VS ê·€ê°€ ë¶„ì„');
            const container = document.getElementById('chartsContainer');
            container.insertAdjacentHTML('afterbegin', chartHtml);

            const ctx = document.getElementById('resultChart').getContext('2d');
            generatedCharts.resultChart = new Chart(ctx, {
                type: 'pie',
                plugins: [ChartDataLabels],
                data: {
                    labels: resultLabels,
                    datasets: [{
                        label: 'í™˜ììˆ˜',
                        data: resultCounts,
                        backgroundColor: ChartGenerator.getAcademicColorPalette(resultLabels.length),
                        borderWidth: 3,
                        borderColor: '#ffffff'
                    }]
                },
                options: ChartGenerator.getPieChartOptions('ì§„ë£Œê²°ê³¼ë³„ í™˜ì ë¶„í¬')
            });
        }

        // 7. ì…ì›ê³¼ë³„ í™˜ììˆ˜ ê·¸ë˜í”„
        function generateAdmissionDepartmentChart() {
            if (!patientData) {
                alert('ë¨¼ì € í™˜ì ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }

            const admittedPatients = patientData.filter(patient => 
                patient.admissionDept && patient.admissionDept.trim() !== ''
            );

            if (admittedPatients.length === 0) {
                alert('ì…ì›ê³¼ ë°ì´í„°ê°€ ìˆëŠ” í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const deptStats = {};
            admittedPatients.forEach(patient => {
                const dept = patient.admissionDept.trim();
                deptStats[dept] = (deptStats[dept] || 0) + 1;
            });

            const sortedDepts = Object.keys(deptStats).sort((a, b) => deptStats[b] - deptStats[a]);
            const deptCounts = sortedDepts.map(dept => deptStats[dept]);

            const chartHtml = ChartGenerator.createChartContainer('deptChart', 'ì…ì›ê³¼ë³„ í™˜ììˆ˜ ë¶„ì„');
            const container = document.getElementById('chartsContainer');
            container.insertAdjacentHTML('afterbegin', chartHtml);

            const ctx = document.getElementById('deptChart').getContext('2d');
            
            if (sortedDepts.length > 8) {
                generatedCharts.deptChart = new Chart(ctx, {
                    type: 'doughnut',
                    plugins: [ChartDataLabels],
                    data: {
                        labels: sortedDepts,
                        datasets: [{
                            label: 'ì…ì› í™˜ììˆ˜',
                            data: deptCounts,
                            backgroundColor: ChartGenerator.getAcademicColorPalette(sortedDepts.length),
                            borderWidth: 3,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: ChartGenerator.getPieChartOptions('ì…ì›ê³¼ë³„ í™˜ììˆ˜ ë¶„í¬')
                });
            } else {
                generatedCharts.deptChart = new Chart(ctx, {
                    type: 'bar',
                    plugins: [ChartDataLabels],
                    data: {
                        labels: sortedDepts,
                        datasets: [{
                            label: 'ì…ì› í™˜ììˆ˜',
                            data: deptCounts,
                            backgroundColor: ChartGenerator.getAcademicColorPalette(sortedDepts.length),
                            borderColor: '#1e293b',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        ...ChartGenerator.getCommonOptions('ì…ì›ê³¼ë³„ í™˜ììˆ˜', true),
                        indexAxis: 'y',
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'í™˜ììˆ˜ (ëª…)',
                                    font: { size: 12, weight: '600' }
                                },
                                grid: { color: '#e2e8f0' },
                                ticks: { font: { size: 11 } }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'ì…ì›ê³¼',
                                    font: { size: 12, weight: '600' }
                                },
                                grid: { color: '#e2e8f0' },
                                ticks: { font: { size: 11 } }
                            }
                        }
                    }
                });
            }
        }

        // 8. ì‘ê¸‰ì‹¤ ì˜ì‚¬ë³„ í™˜ììˆ˜
        function generateDoctorPatientChart() {
            if (!patientData) {
                alert('ë¨¼ì € í™˜ì ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }

            const doctorStats = {};
            patientData.forEach(patient => {
                if (patient.doctor !== 'Unknown') {
                    const doctor = patient.doctor;
                    doctorStats[doctor] = (doctorStats[doctor] || 0) + 1;
                }
            });

            const sortedDoctors = Object.keys(doctorStats).sort((a, b) => doctorStats[b] - doctorStats[a]);
            const doctorCounts = sortedDoctors.map(doctor => doctorStats[doctor]);

            const chartHtml = ChartGenerator.createChartContainer('doctorChart', 'ì‘ê¸‰ì‹¤ ì˜ì‚¬ë³„ í™˜ììˆ˜');
            const container = document.getElementById('chartsContainer');
            container.insertAdjacentHTML('afterbegin', chartHtml);

            const ctx = document.getElementById('doctorChart').getContext('2d');
            generatedCharts.doctorChart = new Chart(ctx, {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: {
                    labels: sortedDoctors,
                    datasets: [{
                        label: 'ë‹´ë‹¹ í™˜ììˆ˜',
                        data: doctorCounts,
                        backgroundColor: ChartGenerator.getAcademicColorPalette(sortedDoctors.length),
                        borderColor: '#1e293b',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    ...ChartGenerator.getCommonOptions('ì‘ê¸‰ì‹¤ ì˜ì‚¬ë³„ í™˜ììˆ˜', true),
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'í™˜ììˆ˜ (ëª…)',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ì˜ì‚¬ëª…',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        }
                    }
                }
            });
        }

        /* ========================================
           ğŸ“¦ MODULE: ì°¨íŠ¸ ê´€ë¦¬ í•¨ìˆ˜ë“¤
           ======================================== */

        // ì „ì²´ ì°¨íŠ¸ ìƒì„± 
        function generateAllCharts() {
            console.log('ğŸš€ ì „ì²´ ì°¨íŠ¸ ìƒì„± ì‹œì‘...');
            
            if (!patientData) {
                alert('ë¨¼ì € í™˜ì ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!analysisResults) {
                alert('ë°ì´í„° ë¶„ì„ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            // ê¸°ì¡´ ì°¨íŠ¸ ëª¨ë‘ ì œê±°
            document.getElementById('chartsContainer').innerHTML = '';
            generatedCharts = {};

            // ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜ë“¤
            const chartFunctions = [
                { func: generateDailyPatientChart, name: 'ì¼ë³„ í™˜ììˆ˜', id: 'daily' },
                { func: generateWeeklyAverageChart, name: 'ìš”ì¼ë³„ í‰ê· í™˜ììˆ˜', id: 'weekly' },
                { func: generateHourlyAverageChart, name: 'ì‹œê°„ëŒ€ë³„ ë‚´ì›í™˜ììˆ˜', id: 'hourly' },
                { func: generateRealtimeOccupancyChart, name: 'ì‹¤ì‹œê°„ ë¶„ë‹¹ ì¬ì‹¤í™˜ììˆ˜', id: 'realtime' },
                { func: generateKTASDistributionChart, name: 'KTASë³„ í™˜ì ë¶„í¬', id: 'ktas' },
                { func: generateAdmissionVsDischargeChart, name: 'ì…ì› VS ê·€ê°€ ë¶„ì„', id: 'admission' },
                { func: generateAdmissionDepartmentChart, name: 'ì…ì›ê³¼ë³„ í™˜ììˆ˜', id: 'department' },
                { func: generateDoctorPatientChart, name: 'ì˜ì‚¬ë³„ í™˜ììˆ˜', id: 'doctor' }
            ];

            // ì§„í–‰ ìƒí™© í‘œì‹œ
            const container = document.getElementById('chartsContainer');
            container.innerHTML = `
                <div class="text-center py-4 mb-4" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 12px;">
                    <div class="spinner-academic mx-auto mb-3"></div>
                    <h5 style="color: #1e293b;">ğŸ“Š ${chartFunctions.length}ê°œ ì°¨íŠ¸ ìƒì„± ì¤‘...</h5>
                    <p class="text-muted mb-0" id="progressText">ì¤€ë¹„ ì¤‘...</p>
                </div>
            `;

            // ì°¨íŠ¸ ìƒì„± ì‹œì‘
            setTimeout(() => {
                container.innerHTML = '';
                let successCount = 0;
                let errorCount = 0;

                chartFunctions.forEach((chartInfo, index) => {
                    try {
                        console.log(`ğŸ“ˆ ${index + 1}/${chartFunctions.length}: ${chartInfo.name} ìƒì„± ì¤‘...`);
                        
                        chartInfo.func();
                        
                        successCount++;
                        console.log(`âœ… ${chartInfo.name} ìƒì„± ì™„ë£Œ`);
                        
                    } catch (error) {
                        errorCount++;
                        console.error(`âŒ ${chartInfo.name} ìƒì„± ì˜¤ë¥˜:`, error);
                        
                        container.innerHTML += `
                            <div class="alert alert-warning" role="alert">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>${chartInfo.name}</strong> ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                            </div>
                        `;
                    }
                });

                // ì™„ë£Œ ë©”ì‹œì§€
                setTimeout(() => {
                    const totalGenerated = Object.keys(generatedCharts).length;
                    console.log(`ğŸ‰ ì°¨íŠ¸ ìƒì„± ì™„ë£Œ: ì„±ê³µ ${successCount}ê°œ, ì˜¤ë¥˜ ${errorCount}ê°œ`);
                    
                    if (totalGenerated > 0) {
                        alert(`âœ… ì´ ${totalGenerated}ê°œì˜ ë¶„ì„ ì°¨íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì„±ê³µ: ${successCount}ê°œ\nì˜¤ë¥˜: ${errorCount}ê°œ\n\nìƒì„±ëœ ì°¨íŠ¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.`);
                        
                        // ì‹¤ì‹œê°„ ë°ì´í„° ì €ì¥ (ì°¨íŠ¸ ìƒì„± í›„)
                        if (realtimeOccupancyData) {
                            StorageManager.saveData(patientData, analysisResults, realtimeOccupancyData);
                        }
                    } else {
                        alert('âŒ ì°¨íŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë°ì´í„°ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    }
                }, 1000);
            }, 800);
        }

        // ê°œë³„ ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜ë“¤ì— ì˜¤ë¥˜ ì²˜ë¦¬ ì¶”ê°€
        function safeGenerateChart(chartFunction, chartName) {
            try {
                console.log(`ğŸ“Š ${chartName} ì°¨íŠ¸ ìƒì„± ì‹œì‘...`);
                chartFunction();
                console.log(`âœ… ${chartName} ì°¨íŠ¸ ìƒì„± ì™„ë£Œ`);
                
                // ì‹¤ì‹œê°„ ë°ì´í„° ì €ì¥ (ê°œë³„ ì°¨íŠ¸ ìƒì„± í›„)
                if (realtimeOccupancyData) {
                    StorageManager.saveData(patientData, analysisResults, realtimeOccupancyData);
                }
            } catch (error) {
                console.error(`âŒ ${chartName} ì°¨íŠ¸ ìƒì„± ì˜¤ë¥˜:`, error);
                alert(`${chartName} ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.message}`);
            }
        }

        /* ========================================
           ğŸ“¦ MODULE: ë°ì´í„° ë‚´ë³´ë‚´ê¸° í•¨ìˆ˜ë“¤
           ======================================== */
        function exportPatientData() {
            if (!patientData || !analysisResults) {
                alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const exportData = {
                _meta: {
                    exportTime: new Date().toISOString(),
                    systemName: "ER-Monitoring-Academic-Shared",
                    description: "ì‘ê¸‰ì‹¤ í™˜ì ë°ì´í„° ë¶„ì„ ê²°ê³¼ (ê³µìœ  ë²„ì „)",
                    version: "2.0-shared"
                },
                statistics: analysisResults,
                patientData: patientData,
                realtimeOccupancyData: realtimeOccupancyData,
                summary: {
                    totalRecords: patientData.length,
                    dataQuality: "ê²€ì¦ ì™„ë£Œ",
                    readyForAnalysis: true,
                    sharingEnabled: isDataShared
                }
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ER_Patient_Analysis_Shared_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportAllChartsData() {
            if (!patientData || Object.keys(generatedCharts).length === 0) {
                alert('ìƒì„±ëœ ì°¨íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì°¨íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }

            const chartsData = {};
            Object.keys(generatedCharts).forEach(chartId => {
                const chart = generatedCharts[chartId];
                chartsData[chartId] = {
                    type: chart.config.type,
                    data: chart.data,
                    options: chart.options
                };
            });

            const exportData = {
                _meta: {
                    exportTime: new Date().toISOString(),
                    systemName: "ER-Monitoring-Academic-Charts-Shared",
                    description: "ì‘ê¸‰ì‹¤ ë¶„ì„ ì°¨íŠ¸ ë°ì´í„° (ê³µìœ  ë²„ì „)",
                    chartsGenerated: Object.keys(generatedCharts).length,
                    version: "2.0-shared"
                },
                patientStatistics: analysisResults,
                chartConfigurations: chartsData,
                realtimeOccupancyData: realtimeOccupancyData,
                rawPatientData: patientData,
                analysisTypes: [
                    "ì¼ë³„ í™˜ììˆ˜", "ìš”ì¼ë³„ í‰ê· í™˜ììˆ˜", "ì‹œê°„ëŒ€ë³„ ë‚´ì›í™˜ììˆ˜", "ì‹¤ì‹œê°„ ë¶„ë‹¹ ì¬ì‹¤í™˜ììˆ˜",
                    "KTASë³„ í™˜ì ë¶„í¬", "ì…ì› VS ê·€ê°€", "ì…ì›ê³¼ë³„ í™˜ììˆ˜", "ì˜ì‚¬ë³„ í™˜ììˆ˜"
                ],
                sharing: {
                    enabled: isDataShared,
                    githubReady: true,
                    collaborativeAnalysis: true
                }
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ER_Academic_Charts_Shared_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            alert('âœ… ëª¨ë“  ë¶„ì„ ì°¨íŠ¸ ë°ì´í„°ê°€ ê³µìœ  ë²„ì „ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nGitHubì—ì„œ ë‹¤ë¥¸ ì—°êµ¬ìë“¤ê³¼ ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }

        console.log('ğŸ¥ í†µí•©ëœ ì‘ê¸‰ì‹¤ ìš´ì˜ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ (ë°ì´í„° ê³µìœ  ë²„ì „) ë¡œë“œ ì™„ë£Œ');
    </script>
</body>
</html>