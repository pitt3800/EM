        /* ========================================
           📦 MODULE: 기본 CSS 변수 및 스타일
           ======================================== */

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>응급실 통합 모니터링 시스템 - 연구 논문용</title>
    
    <!-- 외부 라이브러리 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ========================================
           📦 MODULE: 기본 CSS 변수 및 스타일
           ======================================== */
        :root {
            --primary-color: #2563eb;
            --secondary-color: #f8fafc;
            --accent-color: #06b6d4;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1e293b;
            --light-color: #f1f5f9;
            --border-color: #e2e8f0;
            --medical-blue: #667eea;
            --medical-purple: #764ba2;
        }

        body {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #e2e8f0 100%);
            font-family: 'Inter', 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ========================================
           📦 MODULE: 헤더 및 네비게이션
           ======================================== */
        .header-section {
            background: linear-gradient(135deg, var(--medical-blue) 0%, var(--medical-purple) 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .header-section .container {
            position: relative;
            z-index: 1;
        }

        .header-section h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header-section .lead {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        /* 탭 네비게이션 */
        .nav-tabs-custom {
            border: none;
            margin-bottom: 2rem;
        }

        .nav-tabs-custom .nav-link {
            border: none;
            background: white;
            color: var(--dark-color);
            font-weight: 500;
            padding: 1rem 2rem;
            margin-right: 0.5rem;
            border-radius: 10px 10px 0 0;
            transition: all 0.3s ease;
        }

        .nav-tabs-custom .nav-link:hover {
            background: var(--light-color);
            color: var(--primary-color);
        }

        .nav-tabs-custom .nav-link.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            border-color: var(--primary-color);
        }

        /* ========================================
           📦 MODULE: 카드 및 모듈 스타일
           ======================================== */
        .module-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .module-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        .module-header {
            background: linear-gradient(135deg, var(--dark-color) 0%, #334155 100%);
            color: white;
            padding: 1.5rem 2rem;
            font-weight: 600;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-body {
            padding: 2rem;
        }

        /* ========================================
           📦 MODULE: 데이터 관리자 스타일
           ======================================== */
        .data-manager {
            background: var(--light-color);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .data-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .data-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .data-item:hover {
            background: var(--primary-color);
            color: white;
            transform: translateX(5px);
        }

        .data-item.selected {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        /* ========================================
           📦 MODULE: 파일 업로드 영역
           ======================================== */
        .file-drop-area {
            border: 2px dashed var(--primary-color);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .file-drop-area:hover {
            border-color: var(--accent-color);
            background: linear-gradient(135deg, #e0f2fe 0%, #cffafe 100%);
            transform: translateY(-2px);
        }

        .file-drop-area.drag-over {
            border-color: var(--success-color);
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        }

        /* ========================================
           📦 MODULE: 버튼 스타일
           ======================================== */
        .btn-primary-academic {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            border: none;
            color: white;
            font-weight: 500;
            padding: 12px 28px;
            border-radius: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn-primary-academic:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
            color: white;
        }

        .btn-medical {
            background: linear-gradient(45deg, var(--medical-blue), var(--medical-purple));
            border: none;
            color: white;
            font-weight: bold;
            padding: 12px 30px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .btn-medical:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            color: white;
        }

        /* ========================================
           📦 MODULE: 차트 분석 버튼 그리드
           ======================================== */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analysis-btn {
            background: white;
            border: 2px solid var(--border-color);
            color: var(--dark-color);
            padding: 1.5rem;
            border-radius: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        .analysis-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(37,99,235,0.1), transparent);
            transition: left 0.5s ease;
        }

        .analysis-btn:hover::before {
            left: 100%;
        }

        .analysis-btn:hover {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37,99,235,0.2);
        }

        .analysis-btn i {
            font-size: 1.8rem;
            margin-bottom: 12px;
            display: block;
            opacity: 0.8;
        }

        .analysis-btn small {
            opacity: 0.7;
            font-style: italic;
        }

        /* ========================================
           📦 MODULE: 차트 컨테이너
           ======================================== */
        .chart-container {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }

        .chart-header {
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 15px;
            margin-bottom: 25px;
            position: relative;
        }

        .chart-header h5 {
            color: var(--dark-color);
            font-weight: 600;
            margin: 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* ========================================
           📦 MODULE: 스케줄 변환기 스타일
           ======================================== */
        .schedule-input-area {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            min-height: 200px;
            font-family: monospace;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .schedule-input-area:focus {
            outline: none;
            border-color: var(--medical-blue);
            background: #fff;
        }

        .result-table {
            font-size: 0.85em;
        }

        .result-table th {
            background: linear-gradient(45deg, var(--medical-blue), var(--medical-purple));
            color: white;
            text-align: center;
            font-size: 0.8em;
            padding: 8px 4px;
        }

        .result-table td {
            text-align: center;
            padding: 6px 4px;
        }

        .weekend-row {
            background-color: #fff3cd;
        }

        /* ========================================
           📦 MODULE: 반응형 디자인
           ======================================== */
        @media (max-width: 768px) {
            .header-section h1 {
                font-size: 2rem;
            }
            
            .analysis-grid {
                grid-template-columns: 1fr;
            }
            
            .card-body {
                padding: 1.5rem;
            }
            
            .module-header {
                padding: 1rem 1.5rem;
            }
        }
    </style>
</head>



<body>
    <!-- ========================================
         📦 MODULE: 페이지 헤더
         ======================================== -->
    <div class="header-section">
        <div class="container">
            <h1><i class="fas fa-hospital-alt"></i> 응급실 통합 모니터링 시스템</h1>
            <p class="lead">Emergency Department Integrated Analysis System for Research</p>
        </div>
    </div>

    <div class="container">
        <!-- ========================================
             📦 MODULE: 탭 네비게이션
             ======================================== -->
        <ul class="nav nav-tabs nav-tabs-custom" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="patient-tab" data-bs-toggle="tab" data-bs-target="#patient-analysis" type="button" role="tab">
                    <i class="fas fa-users"></i> 환자 데이터 분석
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule-management" type="button" role="tab">
                    <i class="fas fa-calendar-alt"></i> 근무 스케줄 관리
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-management" type="button" role="tab">
                    <i class="fas fa-database"></i> 데이터 관리
                </button>
            </li>
        </ul>

        <!-- ========================================
             📦 MODULE: 탭 콘텐츠
             ======================================== -->
        <div class="tab-content" id="mainTabContent">
            
            <!-- ========================================
                 📦 MODULE: 환자 데이터 분석 탭
                 ======================================== -->
            <div class="tab-pane fade show active" id="patient-analysis" role="tabpanel">
                
                <!-- 환자 데이터 업로드 -->
                <div class="module-card">
                    <div class="module-header">
                        <i class="fas fa-upload"></i> 환자 데이터 업로드
                    </div>
                    <div class="card-body">
                        <div class="file-drop-area" id="patientFileDropArea">
                            <i class="fas fa-cloud-upload-alt fa-4x mb-3" style="color: var(--primary-color);"></i>
                            <h5>환자 데이터 엑셀 파일 업로드</h5>
                            <p class="text-muted mb-3">파일을 여기에 드래그하거나 클릭하여 선택하세요</p>
                            <input type="file" id="patientFileInput" accept=".xlsx,.xls" style="display: none;">
                            <button class="btn btn-primary-academic" onclick="document.getElementById('patientFileInput').click()">
                                <i class="fas fa-folder-open"></i> 파일 선택
                            </button>
                            <button class="btn btn-outline-primary ms-2" onclick="loadDemoPatientData()">
                                <i class="fas fa-flask"></i> 데모 데이터
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 분석 결과 -->
                <div class="module-card" id="patientAnalysisResults" style="display: none;">
                    <div class="module-header">
                        <i class="fas fa-chart-bar"></i> 환자 데이터 분석 결과
                    </div>
                    <div class="card-body">
                        <!-- 통계 카드들 -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h3 id="totalPatients">0</h3>
                                        <small>총 환자수</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h3 id="totalDoctors">0</h3>
                                        <small>응급실 의사수</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h3 id="dateRange">-</h3>
                                        <small>데이터 기간</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h3 id="avgPatientsPerDay">0</h3>
                                        <small>일평균 환자수</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 차트 생성 버튼들 (8개) -->
                        <div class="analysis-grid">
                            <button class="analysis-btn" onclick="safeGenerateChart(generateDailyPatientChart, '일별 환자수')">
                                <i class="fas fa-calendar-day"></i>
                                일별 환자수 분석
                                <small class="d-block mt-2">Daily Patient Volume</small>
                            </button>
                            
                            <button class="analysis-btn" onclick="safeGenerateChart(generateWeeklyAverageChart, '요일별 평균환자수')">
                                <i class="fas fa-calendar-week"></i>
                                요일별 평균환자수
                                <small class="d-block mt-2">Weekly Average</small>
                            </button>
                            
                            <button class="analysis-btn" onclick="safeGenerateChart(generateHourlyAverageChart, '시간대별 내원환자수')">
                                <i class="fas fa-clock"></i>
                                시간대별 내원환자수
                                <small class="d-block mt-2">Hourly Admission</small>
                            </button>
                            
                            <button class="analysis-btn" onclick="safeGenerateChart(generateRealtimeOccupancyChart, '실시간 분당 재실환자수')">
                                <i class="fas fa-bed"></i>
                                실시간 분당 재실환자수
                                <small class="d-block mt-2">Real-time Occupancy</small>
                            </button>
                            
                            <button class="analysis-btn" onclick="safeGenerateChart(generateKTASDistributionChart, 'KTAS별 환자 분포')">
                                <i class="fas fa-exclamation-triangle"></i>
                                KTAS별 환자 분포
                                <small class="d-block mt-2">Acuity Distribution</small>
                            </button>
                            
                            <button class="analysis-btn" onclick="safeGenerateChart(generateAdmissionVsDischargeChart, '입원 VS 귀가 분석')">
                                <i class="fas fa-procedures"></i>
                                입원 VS 귀가 분석
                                <small class="d-block mt-2">Disposition Analysis</small>
                            </button>
                            
                            <button class="analysis-btn" onclick="safeGenerateChart(generateAdmissionDepartmentChart, '입원과별 환자수')">
                                <i class="fas fa-hospital"></i>
                                입원과별 환자수
                                <small class="d-block mt-2">Department Distribution</small>
                            </button>
                            
                            <button class="analysis-btn" onclick="safeGenerateChart(generateDoctorPatientChart, '의사별 환자수')">
                                <i class="fas fa-user-md"></i>
                                응급실 의사별 환자수
                                <small class="d-block mt-2">Physician Workload</small>
                            </button>
                        </div>

                        <!-- 전체 분석 실행 버튼 -->
                        <div class="text-center mb-4">
                            <button class="btn btn-success btn-lg" onclick="generateAllPatientCharts()">
                                <i class="fas fa-chart-pie"></i> 전체 환자 분석 차트 생성
                            </button>
                        </div>

                        <!-- 차트 표시 영역 -->
                        <div id="patientChartsContainer"></div>
                    </div>
                </div>
            </div>

            <!-- ========================================
                 📦 MODULE: 근무 스케줄 관리 탭
                 ======================================== -->
            <div class="tab-pane fade" id="schedule-management" role="tabpanel">
                
                <!-- 스케줄 데이터 입력 -->
                <div class="module-card">
                    <div class="module-header">
                        <i class="fas fa-paste"></i> 근무 스케줄 데이터 입력
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info" role="alert">
                            <h6><i class="fas fa-info-circle"></i> 근무시간 기준</h6>
                            <ul class="mb-0">
                                <li><strong>D (Day):</strong> 8:00~18:00 (10시간)</li>
                                <li><strong>MDH (Mid-Day Holiday):</strong> 10:00~14:00 (4시간)</li>
                                <li><strong>MD (Mid-Day):</strong> 16:00~익일 01:00 (9시간)</li>
                                <li><strong>N (Night):</strong> 18:00~익일 08:00 또는 23:00~08:00 (14시간 또는 9시간)</li>
                            </ul>
                        </div>
                        
                        <textarea class="schedule-input-area w-100" id="scheduleData" 
                                  placeholder="근무 스케줄 데이터를 입력하세요...

형식: 날짜|요일|D1|D2|MDH|MD|N1|N2

예시:
1|화|이||강|강|정|
2|수|허||박|박|강|
3|목|권||강|오|선|"></textarea>
                        
                        <div class="text-center mt-3">
                            <button class="btn btn-medical btn-lg" onclick="processScheduleData()">
                                <i class="fas fa-cogs"></i> 스케줄 변환
                            </button>
                            <button class="btn btn-outline-secondary btn-lg ms-2" onclick="loadSampleSchedule()">
                                <i class="fas fa-flask"></i> 샘플 로드
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 스케줄 변환 결과 -->
                <div class="module-card" id="scheduleResults" style="display: none;">
                    <div class="module-header">
                        <i class="fas fa-table"></i> 스케줄 변환 결과
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered result-table" id="scheduleTable">
                                <!-- 스케줄 테이블이 여기에 생성됩니다 -->
                            </table>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button class="btn btn-success btn-lg" onclick="generateDoctorWorkHoursChart()">
                                <i class="fas fa-chart-pie"></i> 의사별 총 근무시간 차트
                            </button>
                            <button class="btn btn-info btn-lg ms-2" onclick="generateWorkloadAnalysis()">
                                <i class="fas fa-chart-bar"></i> 근무량 분석
                            </button>
                        </div>

                        <!-- 스케줄 차트 표시 영역 -->
                        <div id="scheduleChartsContainer" class="mt-4"></div>
                    </div>
                </div>
            </div>

            <!-- ========================================
                 📦 MODULE: 데이터 관리 탭
                 ======================================== -->
            <div class="tab-pane fade" id="data-management" role="tabpanel">
                
                <!-- 저장된 데이터 목록 -->
                <div class="module-card">
                    <div class="module-header">
                        <i class="fas fa-database"></i> 저장된 데이터 관리
                    </div>
                    <div class="card-body">
                        <div class="data-manager">
                            <h6><i class="fas fa-list"></i> 업로드된 데이터 목록</h6>
                            <div class="data-list" id="dataList">
                                <div class="text-center text-muted py-4">
                                    아직 업로드된 데이터가 없습니다.
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-primary-academic" onclick="refreshDataList()">
                                    <i class="fas fa-sync"></i> 목록 새로고침
                                </button>
                                <button class="btn btn-danger ms-2" onclick="clearAllData()">
                                    <i class="fas fa-trash"></i> 모든 데이터 삭제
                                </button>
                            </div>
                        </div>

                        <!-- 선택된 데이터 정보 -->
                        <div id="selectedDataInfo" style="display: none;">
                            <h6><i class="fas fa-info-circle"></i> 선택된 데이터 정보</h6>
                            <div class="card">
                                <div class="card-body">
                                    <div id="dataInfoContent"></div>
                                    <button class="btn btn-success mt-3" onclick="analyzeSelectedData()">
                                        <i class="fas fa-play"></i> 이 데이터로 분석 시작
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>

    <script>
        /* ========================================
           📦 MODULE: 전역 변수 및 상태 관리
           ======================================== */
        let patientData = null;
        let scheduleData = {};
        let selectedDataKey = null;
        let generatedCharts = {};
        let analysisResults = null;
        let realtimeOccupancyData = null;

        // Chart.js 데이터레이블 플러그인 등록
        Chart.register(ChartDataLabels);

        /* ========================================
           📦 MODULE: 데이터 저장 관리자 (개선된 버전)
           ======================================== */
        const DataManager = {
            // 저장된 데이터 키 목록 가져오기
            getStoredDataKeys: function() {
                const keys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('er_data_')) {
                        keys.push(key);
                    }
                }
                return keys.sort();
            },

            // 로컬스토리지 용량 확인
            checkStorageQuota: function() {
                try {
                    if (navigator.storage && navigator.storage.estimate) {
                        navigator.storage.estimate().then(estimate => {
                            const usedMB = Math.round(estimate.usage / 1024 / 1024 * 100) / 100;
                            const quotaMB = Math.round(estimate.quota / 1024 / 1024 * 100) / 100;
                            console.log(`💾 스토리지 사용량: ${usedMB}MB / ${quotaMB}MB`);
                        });
                    }
                    
                    // 로컬스토리지 크기 추정
                    let localStorageSize = 0;
                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key)) {
                            localStorageSize += localStorage[key].length + key.length;
                        }
                    }
                    const localStorageMB = Math.round(localStorageSize / 1024 / 1024 * 100) / 100;
                    console.log(`💾 로컬스토리지 사용량: ${localStorageMB}MB`);
                    
                    return localStorageMB;
                } catch (error) {
                    console.error('스토리지 용량 확인 오류:', error);
                    return 0;
                }
            },

            // 데이터 압축 (큰 데이터를 위한)
            compressData: function(data) {
                try {
                    // 간단한 압축: 불필요한 필드 제거 및 데이터 최적화
                    if (Array.isArray(data)) {
                        return data.map(item => {
                            // 환자 데이터 최적화
                            if (item.visitDate && item.visitTime) {
                                return {
                                    vd: item.visitDate,
                                    vt: item.visitTime,
                                    doc: item.doctor,
                                    age: item.age,
                                    ktas: item.ktas,
                                    result: item.result,
                                    hour: item.hour,
                                    dayOfWeek: item.dayOfWeek,
                                    stayMinutes: item.stayMinutes
                                };
                            }
                            return item;
                        });
                    }
                    return data;
                } catch (error) {
                    console.warn('데이터 압축 실패, 원본 데이터 사용:', error);
                    return data;
                }
            },

            // 데이터 압축 해제
            decompressData: function(compressedData) {
                try {
                    if (Array.isArray(compressedData)) {
                        return compressedData.map(item => {
                            // 압축된 환자 데이터 복원
                            if (item.vd && item.vt) {
                                return {
                                    visitDate: item.vd,
                                    visitTime: item.vt,
                                    doctor: item.doc,
                                    age: item.age,
                                    ktas: item.ktas,
                                    result: item.result,
                                    hour: item.hour,
                                    dayOfWeek: item.dayOfWeek,
                                    stayMinutes: item.stayMinutes,
                                    // 복원된 필드들
                                    visitDateTime: new Date(`${item.vd} ${item.vt}:00`),
                                    timeCategory: item.hour >= 8 && item.hour < 18 ? 'D' : 'N',
                                    isValid: true
                                };
                            }
                            return item;
                        });
                    }
                    return compressedData;
                } catch (error) {
                    console.warn('데이터 압축 해제 실패, 원본 데이터 사용:', error);
                    return compressedData;
                }
            },

            // 기존 데이터 정리 (용량 확보)
            cleanupOldData: function() {
                try {
                    const keys = this.getStoredDataKeys();
                    if (keys.length > 10) { // 10개 이상이면 오래된 것 삭제
                        const sortedKeys = keys.sort((a, b) => {
                            const timeA = parseInt(a.split('_')[2]);
                            const timeB = parseInt(b.split('_')[2]);
                            return timeA - timeB;
                        });
                        
                        // 가장 오래된 5개 삭제
                        const keysToDelete = sortedKeys.slice(0, 5);
                        keysToDelete.forEach(key => {
                            localStorage.removeItem(key);
                            console.log(`🗑️ 오래된 데이터 삭제: ${key}`);
                        });
                        
                        return keysToDelete.length;
                    }
                    return 0;
                } catch (error) {
                    console.error('데이터 정리 오류:', error);
                    return 0;
                }
            },

            // 개선된 데이터 저장
            saveData: function(data, name, type = 'patient') {
                const timestamp = new Date().toISOString();
                const key = `er_data_${type}_${Date.now()}`;
                
                try {
                    // 1단계: 스토리지 용량 확인
                    const currentUsage = this.checkStorageQuota();
                    
                    // 2단계: 데이터 크기 추정
                    let dataToSave = data;
                    if (type === 'patient' && Array.isArray(data) && data.length > 100) {
                        // 큰 환자 데이터는 압축
                        dataToSave = this.compressData(data);
                        console.log(`📦 데이터 압축: ${data.length} → ${dataToSave.length} 레코드`);
                    }
                    
                    const dataObject = {
                        name: name,
                        type: type,
                        timestamp: timestamp,
                        data: dataToSave,
                        compressed: dataToSave !== data,
                        version: '2.0'
                    };
                    
                    const jsonString = JSON.stringify(dataObject);
                    const dataSizeMB = Math.round(jsonString.length / 1024 / 1024 * 100) / 100;
                    
                    console.log(`💾 저장할 데이터 크기: ${dataSizeMB}MB`);
                    
                    // 3단계: 용량 초과 시 정리
                    if (dataSizeMB > 2) { // 2MB 이상이면 정리
                        const cleaned = this.cleanupOldData();
                        if (cleaned > 0) {
                            console.log(`🧹 ${cleaned}개 오래된 데이터 정리 완료`);
                        }
                    }
                    
                    // 4단계: 실제 저장 시도
                    localStorage.setItem(key, jsonString);
                    console.log('✅ 데이터 저장 완료:', key, `(${dataSizeMB}MB)`);
                    return key;
                    
                } catch (error) {
                    console.error('❌ 데이터 저장 오류:', error);
                    
                    // 5단계: 저장 실패 시 복구 시도
                    if (error.name === 'QuotaExceededError' || error.message.includes('quota')) {
                        console.log('🚨 스토리지 용량 초과, 정리 후 재시도...');
                        
                        try {
                            // 강제 정리
                            const cleaned = this.cleanupOldData();
                            console.log(`🧹 강제 정리: ${cleaned}개 데이터 삭제`);
                            
                            // 더 압축된 데이터로 재시도
                            if (type === 'patient' && Array.isArray(data)) {
                                const minimalData = data.map(item => ({
                                    vd: item.visitDate,
                                    vt: item.visitTime,
                                    doc: item.doctor,
                                    h: item.hour
                                }));
                                
                                const minimalObject = {
                                    name: name + ' (압축됨)',
                                    type: type,
                                    timestamp: timestamp,
                                    data: minimalData,
                                    compressed: true,
                                    minimal: true,
                                    version: '2.0'
                                };
                                
                                localStorage.setItem(key, JSON.stringify(minimalObject));
                                console.log('✅ 압축된 데이터 저장 완료:', key);
                                return key;
                            }
                        } catch (retryError) {
                            console.error('❌ 재시도도 실패:', retryError);
                            // 메모리에만 저장
                            window.tempDataStorage = window.tempDataStorage || {};
                            window.tempDataStorage[key] = {
                                name: name + ' (임시)',
                                type: type,
                                timestamp: timestamp,
                                data: data,
                                temporary: true
                            };
                            console.log('📝 임시 메모리 저장:', key);
                            return key;
                        }
                    }
                    
                    return null;
                }
            },

            // 개선된 데이터 불러오기
            loadData: function(key) {
                try {
                    // 로컬스토리지에서 먼저 시도
                    let dataStr = localStorage.getItem(key);
                    
                    // 임시 메모리 스토리지에서 확인
                    if (!dataStr && window.tempDataStorage && window.tempDataStorage[key]) {
                        console.log('📝 임시 메모리에서 데이터 불러오기:', key);
                        return window.tempDataStorage[key];
                    }
                    
                    if (dataStr) {
                        const parsedData = JSON.parse(dataStr);
                        
                        // 압축된 데이터 복원
                        if (parsedData.compressed && !parsedData.minimal) {
                            console.log('📦 압축된 데이터 복원 중...');
                            parsedData.data = this.decompressData(parsedData.data);
                        }
                        
                        return parsedData;
                    }
                    return null;
                } catch (error) {
                    console.error('❌ 데이터 불러오기 오류:', error);
                    return null;
                }
            },

            // 개선된 데이터 삭제
            deleteData: function(key) {
                try {
                    // 로컬스토리지에서 삭제
                    localStorage.removeItem(key);
                    
                    // 임시 메모리에서도 삭제
                    if (window.tempDataStorage && window.tempDataStorage[key]) {
                        delete window.tempDataStorage[key];
                    }
                    
                    console.log('✅ 데이터 삭제 완료:', key);
                    return true;
                } catch (error) {
                    console.error('❌ 데이터 삭제 오류:', error);
                    return false;
                }
            },

            // 개선된 모든 데이터 삭제
            clearAllData: function() {
                try {
                    const keys = this.getStoredDataKeys();
                    keys.forEach(key => this.deleteData(key));
                    
                    // 임시 메모리도 정리
                    if (window.tempDataStorage) {
                        window.tempDataStorage = {};
                    }
                    
                    console.log('✅ 모든 데이터 삭제 완료');
                } catch (error) {
                    console.error('❌ 데이터 삭제 오류:', error);
                }
            },

            // 저장소 상태 확인
            getStorageStatus: function() {
                try {
                    const totalKeys = this.getStoredDataKeys().length;
                    const memoryKeys = window.tempDataStorage ? Object.keys(window.tempDataStorage).length : 0;
                    const storageUsage = this.checkStorageQuota();
                    
                    return {
                        totalDatasets: totalKeys + memoryKeys,
                        persistentDatasets: totalKeys,
                        temporaryDatasets: memoryKeys,
                        storageUsageMB: storageUsage
                    };
                } catch (error) {
                    console.error('저장소 상태 확인 오류:', error);
                    return { totalDatasets: 0, persistentDatasets: 0, temporaryDatasets: 0, storageUsageMB: 0 };
                }
            }
        };

        /* ========================================
           📦 MODULE: 환자 데이터 분석기
           ======================================== */
        const PatientAnalyzer = {
            // 엑셀 파일 읽기
            readExcelFile: async function(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const workbook = XLSX.read(e.target.result, { type: 'binary' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { 
                                header: 1,
                                defval: null 
                            });
                            resolve(jsonData);
                        } catch (error) {
                            reject(error);
                        }
                    };

                    reader.onerror = function(error) {
                        reject(error);
                    };

                    reader.readAsBinaryString(file);
                });
            },

            // 환자 데이터 파싱
            parsePatientData: function(rawData) {
                const headers = rawData[0];
                const rows = rawData.slice(1);
                
                const getColumnIndex = (columnName) => {
                    return headers.findIndex(header => 
                        header && header.toString().includes(columnName)
                    );
                };

                const indices = {
                    visitDate: getColumnIndex('내원일자'),
                    visitTime: getColumnIndex('내원시간'),
                    patientName: getColumnIndex('이름'),
                    gender: getColumnIndex('성별'),
                    age: getColumnIndex('나이'),
                    doctor: getColumnIndex('응급실의사'),
                    symptom: getColumnIndex('주증상'),
                    ktas: getColumnIndex('KTAS'),
                    result: getColumnIndex('진료결과명'),
                    admissionDept: getColumnIndex('입원과'),
                    stayTime: getColumnIndex('체류시간'),
                    actualExitDate: getColumnIndex('실제퇴실일자'),
                    actualExitTime: getColumnIndex('실제퇴실시간')
                };

                const processedData = rows.map((row, index) => {
                    try {
                        let visitDate = row[indices.visitDate];
                        if (visitDate) {
                            visitDate = visitDate.toString();
                            if (visitDate.length === 8) {
                                visitDate = `${visitDate.substr(0,4)}-${visitDate.substr(4,2)}-${visitDate.substr(6,2)}`;
                            }
                        }

                        let visitTime = row[indices.visitTime];
                        if (visitTime) {
                            visitTime = visitTime.toString().padStart(4, '0');
                            visitTime = `${visitTime.substr(0,2)}:${visitTime.substr(2,2)}`;
                        }

                        let doctor = row[indices.doctor];
                        if (doctor) {
                            const originalDoctor = doctor.toString().trim();
                            doctor = originalDoctor;
                            const parenthesesIndex = doctor.indexOf('(');
                            if (parenthesesIndex !== -1) {
                                doctor = doctor.substring(0, parenthesesIndex).trim();
                            }
                        }

                        // 체류시간 계산
                        let stayMinutes = this.calculateStayMinutes(row, indices);
                        
                        // 퇴실시간 계산
                        let exitDateTime = null;
                        if (visitDate && visitTime && stayMinutes) {
                            const visitDateTime = new Date(`${visitDate} ${visitTime}:00`);
                            exitDateTime = new Date(visitDateTime.getTime() + stayMinutes * 60 * 1000);
                        }

                        const processedRow = {
                            rowIndex: index + 1,
                            visitDate: visitDate || 'Unknown',
                            visitTime: visitTime || 'Unknown',
                            visitDateTime: visitDate && visitTime ? new Date(`${visitDate} ${visitTime}:00`) : null,
                            exitDateTime: exitDateTime,
                            stayMinutes: stayMinutes,
                            stayHours: stayMinutes ? stayMinutes / 60 : null,
                            patientName: row[indices.patientName] || 'Unknown',
                            gender: row[indices.gender] || 'Unknown',
                            age: row[indices.age] || 'Unknown',
                            doctor: doctor || 'Unknown',
                            symptom: row[indices.symptom] || 'Unknown',
                            ktas: row[indices.ktas] || 'Unknown',
                            result: row[indices.result] || 'Unknown',
                            admissionDept: row[indices.admissionDept] || '',
                            timeCategory: this.categorizeTime(visitTime),
                            dayOfWeek: this.getDayOfWeek(visitDate),
                            hour: visitTime ? parseInt(visitTime.split(':')[0]) : null,
                            isValid: visitDate && visitTime && stayMinutes && stayMinutes > 0
                        };

                        return processedRow;
                    } catch (error) {
                        console.warn(`⚠️ 행 ${index + 1} 처리 오류:`, error);
                        return null;
                    }
                }).filter(item => item !== null);

                console.log(`✅ 데이터 파싱 완료: ${processedData.length}/${rows.length} 행 처리됨`);
                return processedData;
            },

            // 체류시간 계산
            calculateStayMinutes: function(row, indices) {
                // 1순위: '체류시간' 컬럼
                if (indices.stayTime !== -1 && row[indices.stayTime]) {
                    const stayMinutes = parseFloat(row[indices.stayTime]);
                    if (stayMinutes > 0 && stayMinutes < 1440) {
                        return stayMinutes;
                    }
                }
                
                // 2순위: 추정
                return this.estimateStayTime();
            },

            // 추정 체류시간
            estimateStayTime: function() {
                const avgStayHours = 4.8;
                const randomFactor = 0.7 + (Math.random() * 0.6);
                const estimatedHours = avgStayHours * randomFactor;
                return Math.round(estimatedHours * 60);
            },

            categorizeTime: function(timeString) {
                if (!timeString || timeString === 'Unknown') return 'Unknown';
                
                const hour = parseInt(timeString.split(':')[0]);
                
                if (hour >= 8 && hour < 18) return 'D';
                else if (hour >= 18 || hour < 8) return 'N';
                else return 'Unknown';
            },

            getDayOfWeek: function(dateString) {
                if (!dateString || dateString === 'Unknown') return 'Unknown';
                
                try {
                    const date = new Date(dateString);
                    const days = ['일', '월', '화', '수', '목', '금', '토'];
                    return days[date.getDay()];
                } catch (error) {
                    return 'Unknown';
                }
            },

            generateSummaryStats: function(data) {
                const stats = {
                    totalPatients: data.length,
                    dateRange: {
                        start: null,
                        end: null
                    },
                    doctorStats: {},
                    timeStats: {},
                    dailyStats: {},
                    avgPatientsPerDay: 0
                };

                const validDates = data
                    .map(item => item.visitDate)
                    .filter(date => date !== 'Unknown')
                    .sort();
                
                if (validDates.length > 0) {
                    stats.dateRange.start = validDates[0];
                    stats.dateRange.end = validDates[validDates.length - 1];
                }

                data.forEach(item => {
                    if (item.doctor !== 'Unknown') {
                        stats.doctorStats[item.doctor] = (stats.doctorStats[item.doctor] || 0) + 1;
                    }

                    stats.timeStats[item.timeCategory] = (stats.timeStats[item.timeCategory] || 0) + 1;

                    if (item.visitDate !== 'Unknown') {
                        stats.dailyStats[item.visitDate] = (stats.dailyStats[item.visitDate] || 0) + 1;
                    }
                });

                const totalDays = Object.keys(stats.dailyStats).length;
                if (totalDays > 0) {
                    stats.avgPatientsPerDay = Math.round(stats.totalPatients / totalDays);
                }

                console.log('📊 통계 분석 완료:', stats);
                return stats;
            }
        };

        /* ========================================
           📦 MODULE: 스케줄 관리자
           ======================================== */
        const ScheduleManager = {
            // 의사명 매핑
            doctorNameMapping: {
                '강': '강희동',
                '오': '오세현',
                '정': '정상구',
                '이': '이유진',
                '박': '박인준',
                '권': '권재화',
                '선': '선경민',
                '허': '허석진',
                '이2': '이기헌'
            },

            // 근무시간 매핑 (시간 단위)
            shiftHours: {
                'D': 10,    // 8:00~18:00 (10시간)
                'MDH': 4,   // 10:00~14:00 (4시간)
                'MD': 9,    // 16:00~익일 01:00 (9시간)
                'N': 14     // 18:00~익일 08:00 (14시간) 또는 23:00~08:00 (9시간) - 평균 14시간 사용
            },

            // 의사명 변환
            convertDoctorName: function(shortName) {
                const trimmed = shortName.trim();
                return this.doctorNameMapping[trimmed] || trimmed;
            },

            // 스케줄 데이터 파싱
            parseScheduleData: function(rawData) {
                const lines = rawData.split('\n').filter(line => line.trim());
                const parsedData = {};

                lines.forEach((line, index) => {
                    const parts = line.split('|');
                    
                    if (parts.length >= 8) {
                        const day = parseInt(parts[0]);
                        
                        parsedData[day] = {
                            date: `2025-07-${day.toString().padStart(2, '0')}`,
                            day: parts[1].trim(),
                            d1: this.convertDoctorName(parts[2]),
                            d2: this.convertDoctorName(parts[3]),
                            mdh: this.convertDoctorName(parts[4]),
                            md: this.convertDoctorName(parts[5]),
                            n1: this.convertDoctorName(parts[6]),
                            n2: this.convertDoctorName(parts[7])
                        };
                    }
                });

                return parsedData;
            },

            // 의사별 총 근무시간 계산
            calculateTotalWorkHours: function(scheduleData) {
                const workHours = {};
                const staffList = Object.values(this.doctorNameMapping);
                
                // 초기화
                staffList.forEach(staff => {
                    workHours[staff] = 0;
                });

                // 근무시간 계산
                Object.values(scheduleData).forEach(day => {
                    // Day 1, Day 2
                    if (day.d1 && workHours[day.d1] !== undefined) {
                        workHours[day.d1] += this.shiftHours['D'];
                    }
                    if (day.d2 && workHours[day.d2] !== undefined) {
                        workHours[day.d2] += this.shiftHours['D'];
                    }
                    
                    // MDH
                    if (day.mdh && workHours[day.mdh] !== undefined) {
                        workHours[day.mdh] += this.shiftHours['MDH'];
                    }
                    
                    // MD
                    if (day.md && workHours[day.md] !== undefined) {
                        workHours[day.md] += this.shiftHours['MD'];
                    }
                    
                    // Night 1, Night 2
                    if (day.n1 && workHours[day.n1] !== undefined) {
                        workHours[day.n1] += this.shiftHours['N'];
                    }
                    if (day.n2 && workHours[day.n2] !== undefined) {
                        workHours[day.n2] += this.shiftHours['N'];
                    }
                });

                return workHours;
            },

            // 근무량 통계 계산 (기존 기능)
            calculateWorkloadStats: function(scheduleData) {
                const stats = {};
                const staffList = Object.values(this.doctorNameMapping);
                
                // 통계 초기화
                staffList.forEach(staff => {
                    stats[staff] = { d: 0, mdh: 0, md: 0, n: 0, total: 0 };
                });

                // 통계 계산
                Object.values(scheduleData).forEach(day => {
                    if (day.d1 && stats[day.d1]) stats[day.d1].d++;
                    if (day.d2 && stats[day.d2]) stats[day.d2].d++;
                    if (day.mdh && stats[day.mdh]) stats[day.mdh].mdh++;
                    if (day.md && stats[day.md]) stats[day.md].md++;
                    if (day.n1 && stats[day.n1]) stats[day.n1].n++;
                    if (day.n2 && stats[day.n2]) stats[day.n2].n++;
                });

                // 총합 계산
                staffList.forEach(staff => {
                    stats[staff].total = stats[staff].d + stats[staff].mdh + stats[staff].md + stats[staff].n;
                });

                return stats;
            }
        };

        /* ========================================
           📦 MODULE: 차트 생성기
           ======================================== */
        const ChartGenerator = {
            // 공통 차트 옵션
            getCommonOptions: function(title, showDataLabels = false) {
                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            font: { size: 18, weight: '600' },
                            color: '#1e293b',
                            padding: 20
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 12, weight: '500' },
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0, font: { size: 11 } },
                            grid: { color: '#e2e8f0' }
                        },
                        x: {
                            ticks: { font: { size: 11 } },
                            grid: { color: '#e2e8f0' }
                        }
                    }
                };

                if (showDataLabels) {
                    options.plugins.datalabels = {
                        anchor: 'end',
                        align: 'top',
                        font: { weight: '600', size: 11 },
                        color: '#1e293b',
                        formatter: function(value, context) {
                            return value;
                        }
                    };
                }

                return options;
            },

            // 파이 차트 옵션
            getPieChartOptions: function(title) {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            font: { size: 18, weight: '600' },
                            color: '#1e293b',
                            padding: 20
                        },
                        legend: {
                            position: 'right',
                            labels: {
                                font: { size: 12, weight: '500' },
                                padding: 15,
                                usePointStyle: true,
                                boxWidth: 15
                            }
                        },
                        datalabels: {
                            formatter: (value, ctx) => {
                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return percentage >= 5 ? `${value}` : '';
                            },
                            color: '#ffffff',
                            font: { weight: 'bold', size: 12 },
                            textStrokeColor: '#1e293b',
                            textStrokeWidth: 1
                        }
                    }
                };
            },

            // 차트 컨테이너 생성
            createChartContainer: function(id, title) {
                return `
                    <div class="chart-container" id="${id}Container">
                        <div class="chart-header">
                            <h5><i class="fas fa-chart-bar"></i> ${title}</h5>
                        </div>
                        <div style="height: 400px;">
                            <canvas id="${id}"></canvas>
                        </div>
                    </div>
                `;
            },

            // 색상 팔레트
            getAcademicColorPalette: function(count) {
                const colors = [
                    '#2563eb', '#dc2626', '#059669', '#d97706',
                    '#7c3aed', '#0891b2', '#4f46e5', '#ea580c',
                    '#65a30d', '#c2410c', '#7e22ce', '#0e7490'
                ];
                return colors.slice(0, count);
            }
        };

        /* ========================================
           📦 MODULE: 실시간 재실환자수 계산기
           ======================================== */
        const RealtimeOccupancyCalculator = {
            calculateRealtimeOccupancy: function(patients, config = {}) {
                console.log('🏥 === 실시간 분당 재실환자수 계산 ===');
                
                const maxOccupancy = config.maxOccupancy || 35;
                
                const validPatients = patients.filter(p => p.isValid);
                console.log(`📊 유효한 환자: ${validPatients.length}명`);
                
                const dateGroups = {};
                validPatients.forEach(patient => {
                    const date = patient.visitDate;
                    if (!dateGroups[date]) {
                        dateGroups[date] = [];
                    }
                    dateGroups[date].push(patient);
                });
                
                const dates = Object.keys(dateGroups).sort();
                console.log(`📅 분석 날짜: ${dates.length}일`);
                
                const occupancyByDate = {};
                let totalAdjustedPoints = 0;
                
                dates.forEach(date => {
                    const dayResult = this.calculateDayOccupancy(dateGroups[date], date, maxOccupancy);
                    occupancyByDate[date] = dayResult.occupancy;
                    totalAdjustedPoints += dayResult.adjustedPoints;
                });
                
                const minuteAverages = [];
                for (let minute = 0; minute < 1440; minute++) {
                    const occupancyValues = dates.map(date => occupancyByDate[date][minute]);
                    const average = occupancyValues.reduce((sum, val) => sum + val, 0) / dates.length;
                    minuteAverages.push(Math.round(average * 10) / 10);
                }
                
                const statistics = this.calculateStatistics(minuteAverages, validPatients, dates);
                
                console.log(`📊 실시간 재실환자수 결과:`);
                console.log(`   최대: ${statistics.max}명`);
                console.log(`   최소: ${statistics.min}명`);
                console.log(`   평균: ${statistics.average}명`);
                
                return {
                    minuteData: minuteAverages,
                    statistics: statistics,
                    metadata: {
                        totalDays: dates.length,
                        totalPatients: validPatients.length,
                        dailyAverage: validPatients.length / dates.length,
                        adjustedPoints: totalAdjustedPoints,
                        dateRange: `${dates[0]} ~ ${dates[dates.length-1]}`
                    }
                };
            },

            calculateDayOccupancy: function(patients, date, maxOccupancy) {
                const occupancy = new Array(1440).fill(0);
                let adjustedPoints = 0;
                
                const dayStart = new Date(`${date} 00:00:00`);
                const dayEnd = new Date(`${date} 23:59:59`);
                
                const relevantPatients = patients.filter(patient => {
                    return patient.visitDateTime <= dayEnd && patient.exitDateTime > dayStart;
                });
                
                for (let minute = 0; minute < 1440; minute++) {
                    const currentTime = new Date(dayStart.getTime() + minute * 60 * 1000);
                    
                    let count = 0;
                    relevantPatients.forEach(patient => {
                        if (patient.visitDateTime <= currentTime && currentTime < patient.exitDateTime) {
                            count++;
                        }
                    });
                    
                    if (count > maxOccupancy) {
                        count = maxOccupancy;
                        adjustedPoints++;
                    }
                    
                    occupancy[minute] = count;
                }
                
                return {
                    occupancy: occupancy,
                    adjustedPoints: adjustedPoints
                };
            },

            calculateStatistics: function(minuteData, patients, dates) {
                const max = Math.max(...minuteData);
                const min = Math.min(...minuteData);
                const maxIndex = minuteData.indexOf(max);
                const average = minuteData.reduce((sum, val) => sum + val, 0) / 1440;
                
                const hourlySummary = [];
                for (let hour = 0; hour < 24; hour++) {
                    const hourData = minuteData.slice(hour * 60, (hour + 1) * 60);
                    const hourAvg = hourData.reduce((sum, val) => sum + val, 0) / 60;
                    hourlySummary.push(Math.round(hourAvg * 10) / 10);
                }
                
                return {
                    max: max,
                    min: min,
                    maxIndex: maxIndex,
                    average: Math.round(average * 10) / 10,
                    peakTime: `${Math.floor(maxIndex/60).toString().padStart(2, '0')}:${(maxIndex%60).toString().padStart(2, '0')}`,
                    hourlySummary: hourlySummary,
                    totalDays: dates.length,
                    totalPatients: patients.length
                };
            }
        };

        /* ========================================
           📦 MODULE: 데모 데이터 생성기
           ======================================== */
        const DemoDataGenerator = {
            generateDemoData: function() {
                console.log('🎭 데모 데이터 생성 시작...');
                
                const doctors = ['김응급', '박외상', '이내과', '최소아', '정신경'];
                const symptoms = ['복통', '흉통', '두통', '호흡곤란', '외상', '발열', '어지러움'];
                const ktasLevels = [1, 2, 3, 4, 5];
                const results = ['귀가', '입원', '전원', '사망', '자의퇴원'];
                const departments = ['내과', '외과', '정형외과', '신경외과', '소아과', '산부인과'];
                
                const demoPatients = [];
                const baseDate = new Date('2024-06-01');
                
                // 30일간 데이터 생성
                for (let day = 0; day < 30; day++) {
                    const currentDate = new Date(baseDate);
                    currentDate.setDate(baseDate.getDate() + day);
                    const dateStr = currentDate.toISOString().split('T')[0];
                    
                    // 하루에 30-80명의 환자 (요일별 변동)
                    const dayOfWeek = currentDate.getDay();
                    let basePatients = 50;
                    if (dayOfWeek === 0 || dayOfWeek === 6) basePatients += 15; // 주말 증가
                    
                    const dailyPatients = basePatients + Math.floor(Math.random() * 30);
                    
                    for (let p = 0; p < dailyPatients; p++) {
                        // 시간별 분포 (밤과 저녁에 더 많음)
                        let hour;
                        const timeRandom = Math.random();
                        if (timeRandom < 0.3) hour = Math.floor(Math.random() * 8) + 18; // 18-01시 (30%)
                        else if (timeRandom < 0.5) hour = Math.floor(Math.random() * 6) + 6; // 06-11시 (20%)
                        else hour = Math.floor(Math.random() * 24); // 전체 시간 (50%)
                        
                        if (hour >= 24) hour -= 24;
                        
                        const minute = Math.floor(Math.random() * 60);
                        const visitTime = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        
                        // 체류시간 (1-12시간, 대부분 2-6시간)
                        const stayHours = 2 + Math.random() * 4 + (Math.random() < 0.2 ? Math.random() * 6 : 0);
                        const stayMinutes = Math.round(stayHours * 60);
                        
                        // 퇴실시간 계산
                        const visitDateTime = new Date(`${dateStr} ${visitTime}:00`);
                        const exitDateTime = new Date(visitDateTime.getTime() + stayMinutes * 60 * 1000);
                        
                        const patient = {
                            rowIndex: p + 1,
                            visitDate: dateStr,
                            visitTime: visitTime,
                            visitDateTime: visitDateTime,
                            exitDateTime: exitDateTime,
                            stayMinutes: stayMinutes,
                            stayHours: stayHours,
                            patientName: `환자${day * 100 + p + 1}`,
                            gender: Math.random() > 0.5 ? '남' : '여',
                            age: Math.floor(Math.random() * 80) + 10,
                            doctor: doctors[Math.floor(Math.random() * doctors.length)],
                            symptom: symptoms[Math.floor(Math.random() * symptoms.length)],
                            ktas: ktasLevels[Math.floor(Math.random() * ktasLevels.length)],
                            result: results[Math.floor(Math.random() * results.length)],
                            admissionDept: Math.random() > 0.7 ? departments[Math.floor(Math.random() * departments.length)] : '',
                            timeCategory: hour >= 8 && hour < 18 ? 'D' : 'N',
                            dayOfWeek: ['일', '월', '화', '수', '목', '금', '토'][dayOfWeek],
                            hour: hour,
                            isValid: true
                        };
                        
                        demoPatients.push(patient);
                    }
                }
                
                console.log(`✅ 데모 데이터 생성 완료: ${demoPatients.length}명 환자`);
                return demoPatients;
            }
        };

        /* ========================================
           📦 MODULE: 초기화 및 이벤트 핸들러
           ======================================== */
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 응급실 통합 모니터링 시스템 시작');
            initializeSystem();
        });

        function initializeSystem() {
            // 파일 업로드 초기화
            initializeFileUpload();
            
            // 데이터 목록 새로고침
            refreshDataList();
        }

        function initializeFileUpload() {
            const fileInput = document.getElementById('patientFileInput');
            const dropArea = document.getElementById('patientFileDropArea');

            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handlePatientFileUpload(e.target.files[0]);
                }
            });

            dropArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropArea.classList.add('drag-over');
            });

            dropArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropArea.classList.remove('drag-over');
            });

            dropArea.addEventListener('drop', function(e) {
                e.preventDefault();
                dropArea.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length > 0) {
                    handlePatientFileUpload(e.dataTransfer.files[0]);
                }
            });

            dropArea.addEventListener('click', function() {
                fileInput.click();
            });
        }

        /* ========================================
           📦 MODULE: 환자 데이터 처리 함수들 (개선된 버전)
           ======================================== */
        async function handlePatientFileUpload(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('엑셀 파일(.xlsx, .xls)만 업로드 가능합니다.');
                return;
            }

            try {
                console.log('📁 파일 업로드 시작:', file.name);
                
                // 진행 상황 표시
                showUploadProgress('파일 읽는 중...', 25);
                
                const rawData = await PatientAnalyzer.readExcelFile(file);
                showUploadProgress('데이터 파싱 중...', 50);
                
                patientData = PatientAnalyzer.parsePatientData(rawData);
                showUploadProgress('통계 분석 중...', 75);
                
                analysisResults = PatientAnalyzer.generateSummaryStats(patientData);
                showUploadProgress('데이터 저장 중...', 90);
                
                // 개선된 데이터 저장
                const fileName = file.name.replace(/\.(xlsx|xls)$/i, '');
                const savedKey = DataManager.saveData(patientData, fileName, 'patient');
                
                showUploadProgress('완료!', 100);
                
                // 결과 처리
                setTimeout(() => {
                    hideUploadProgress();
                    
                    if (savedKey) {
                        selectedDataKey = savedKey;
                        displayPatientAnalysis();
                        refreshDataList();
                        
                        // 저장 상태 확인
                        const storageStatus = DataManager.getStorageStatus();
                        let message = '✅ 데이터가 성공적으로 업로드되고 저장되었습니다!';
                        
                        if (storageStatus.temporaryDatasets > 0) {
                            message += `\n\n📝 일부 데이터는 임시 메모리에 저장되었습니다.\n(영구 저장: ${storageStatus.persistentDatasets}개, 임시: ${storageStatus.temporaryDatasets}개)`;
                        }
                        
                        alert(message);
                        
                    } else {
                        // 저장에 완전히 실패한 경우에도 분석은 진행
                        displayPatientAnalysis();
                        alert('⚠️ 데이터 분석은 완료되었지만 저장에 실패했습니다.\n\n브라우저 저장 공간이 부족하거나 데이터가 너무 클 수 있습니다.\n분석 결과는 현재 세션에서만 사용 가능합니다.');
                    }
                }, 500);

            } catch (error) {
                hideUploadProgress();
                console.error('❌ 파일 처리 오류:', error);
                alert('파일 처리 중 오류가 발생했습니다:\n\n' + error.message + '\n\n다른 파일을 시도해보시거나 데모 데이터를 사용해주세요.');
            }
        }

        // 업로드 진행 상황 표시
        function showUploadProgress(message, percentage) {
            let progressContainer = document.getElementById('uploadProgressContainer');
            
            if (!progressContainer) {
                progressContainer = document.createElement('div');
                progressContainer.id = 'uploadProgressContainer';
                progressContainer.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border: 2px solid var(--primary-color);
                    border-radius: 12px;
                    padding: 2rem;
                    box-shadow: 0 20px 25px rgba(0,0,0,0.3);
                    z-index: 9999;
                    min-width: 300px;
                    text-align: center;
                `;
                document.body.appendChild(progressContainer);
            }
            
            progressContainer.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--primary-color);"></i>
                </div>
                <h6 style="margin-bottom: 1rem; color: var(--dark-color);">${message}</h6>
                <div style="background: #e2e8f0; border-radius: 10px; overflow: hidden; height: 8px;">
                    <div style="background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                </div>
                <small style="color: var(--dark-color); margin-top: 0.5rem; display: block;">${percentage}%</small>
            `;
        }

        // 업로드 진행 상황 숨기기
        function hideUploadProgress() {
            const progressContainer = document.getElementById('uploadProgressContainer');
            if (progressContainer) {
                document.body.removeChild(progressContainer);
            }
        }

        function loadDemoPatientData() {
            console.log('🎭 환자 데모 데이터 로드 시작...');
            
            try {
                patientData = DemoDataGenerator.generateDemoData();
                analysisResults = PatientAnalyzer.generateSummaryStats(patientData);
                
                // 데모 데이터 저장
                const savedKey = DataManager.saveData(patientData, '환자_데모데이터', 'patient');
                
                if (savedKey) {
                    selectedDataKey = savedKey;
                    refreshDataList();
                }
                
                displayPatientAnalysis();
                alert('✅ 환자 데모 데이터가 로드되었습니다!');
                
            } catch (error) {
                console.error('❌ 데모 데이터 생성 오류:', error);
                alert('데모 데이터 생성 중 오류가 발생했습니다: ' + error.message);
            }
        }

        function displayPatientAnalysis() {
            if (!patientData || !analysisResults) return;
            
            // 통계 카드 업데이트
            document.getElementById('totalPatients').textContent = analysisResults.totalPatients.toLocaleString();
            document.getElementById('totalDoctors').textContent = Object.keys(analysisResults.doctorStats).length;
            
            if (analysisResults.dateRange.start && analysisResults.dateRange.end) {
                const startDate = new Date(analysisResults.dateRange.start);
                const endDate = new Date(analysisResults.dateRange.end);
                document.getElementById('dateRange').textContent = 
                    `${startDate.getMonth()+1}/${startDate.getDate()} - ${endDate.getMonth()+1}/${endDate.getDate()}`;
            }
            
            document.getElementById('avgPatientsPerDay').textContent = analysisResults.avgPatientsPerDay;

            // 분석 결과 섹션 표시
            document.getElementById('patientAnalysisResults').style.display = 'block';
        }

        /* ========================================
           📦 MODULE: 환자 데이터 차트 생성 함수들 (8개)
           ======================================== */

        // 1. 일별 환자수 차트
        function generateDailyPatientChart() {
            console.log('📊 일별 환자수 차트 생성 시작...');
            
            if (!patientData || !analysisResults) {
                throw new Error('환자 데이터 또는 분석 결과가 없습니다.');
            }

            const dailyStats = {};
            patientData.forEach(patient => {
                if (patient.visitDate !== 'Unknown') {
                    const date = patient.visitDate;
                    dailyStats[date] = (dailyStats[date] || 0) + 1;
                }
            });

            const sortedDates = Object.keys(dailyStats).sort();
            const patientCounts = sortedDates.map(date => dailyStats[date]);

            const chartHtml = ChartGenerator.createChartContainer('dailyChart', '일별 환자수 분석');
            const container = document.getElementById('patientChartsContainer');
            container.insertAdjacentHTML('afterbegin', chartHtml);

            const ctx = document.getElementById('dailyChart').getContext('2d');
            generatedCharts.dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates.map(date => {
                        const d = new Date(date);
                        return `${d.getMonth() + 1}/${d.getDate()}`;
                    }),
                    datasets: [{
                        label: '일별 환자수',
                        data: patientCounts,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#2563eb',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    ...ChartGenerator.getCommonOptions('일별 환자수 추이'),
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '환자수 (명)',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '날짜',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        }
                    }
                }
            });
            
            console.log('✅ 일별 환자수 차트 생성 완료');
        }

        // 2. 요일별 평균환자수 차트
        function generateWeeklyAverageChart() {
            console.log('📊 요일별 평균환자수 차트 생성 시작...');
            
            if (!patientData || !analysisResults) {
                throw new Error('환자 데이터 또는 분석 결과가 없습니다.');
            }

            const weeklyStats = {};
            const weeklyCount = {};
            const dayOrder = ['월', '화', '수', '목', '금', '토', '일'];

            patientData.forEach(patient => {
                if (patient.dayOfWeek !== 'Unknown') {
                    const day = patient.dayOfWeek;
                    weeklyStats[day] = (weeklyStats[day] || 0) + 1;
                }
            });

            const dailyCount = {};
            patientData.forEach(patient => {
                if (patient.visitDate !== 'Unknown' && patient.dayOfWeek !== 'Unknown') {
                    const key = `${patient.visitDate}_${patient.dayOfWeek}`;
                    if (!dailyCount[key]) {
                        weeklyCount[patient.dayOfWeek] = (weeklyCount[patient.dayOfWeek] || 0) + 1;
                        dailyCount[key] = true;
                    }
                }
            });

            const averages = dayOrder.map(day => {
                const total = weeklyStats[day] || 0;
                const days = weeklyCount[day] || 1;
                return Math.round(total / days * 10) / 10;
            });

            const chartHtml = ChartGenerator.createChartContainer('weeklyChart', '요일별 평균환자수 분석');
            const container = document.getElementById('patientChartsContainer');
            container.insertAdjacentHTML('afterbegin', chartHtml);

            const ctx = document.getElementById('weeklyChart').getContext('2d');
            generatedCharts.weeklyChart = new Chart(ctx, {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: {
                    labels: dayOrder,
                    datasets: [{
                        label: '평균 환자수',
                        data: averages,
                        backgroundColor: ChartGenerator.getAcademicColorPalette(7),
                        borderColor: '#1e293b',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    ...ChartGenerator.getCommonOptions('요일별 평균 환자수', true),
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '평균 환자수 (명)',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '요일',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        }
                    }
                }
            });
            
            console.log('✅ 요일별 평균환자수 차트 생성 완료');
        }

        // 3. 시간대별 내원환자수 차트
        function generateHourlyAverageChart() {
            if (!patientData) {
                alert('먼저 환자 데이터를 업로드해주세요.');
                return;
            }

            const hourlyStats = {};
            for (let i = 0; i < 24; i++) {
                hourlyStats[i] = 0;
            }

            patientData.forEach(patient => {
                if (patient.hour !== null) {
                    hourlyStats[patient.hour]++;
                }
            });

            const totalDays = Object.keys(analysisResults.dailyStats).length || 1;
            
            const hourlyAverages = [];
            const labels = [];
            for (let i = 0; i < 24; i++) {
                hourlyAverages.push(Math.round(hourlyStats[i] / totalDays * 10) / 10);
                labels.push(`${i.toString().padStart(2, '0')}:00`);
            }

            const chartHtml = ChartGenerator.createChartContainer('hourlyChart', '시간대별 내원환자수 분석');
            const container = document.getElementById('patientChartsContainer');
            container.insertAdjacentHTML('afterbegin', chartHtml);

            const ctx = document.getElementById('hourlyChart').getContext('2d');
            generatedCharts.hourlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '평균 내원환자수',
                        data: hourlyAverages,
                        borderColor: '#059669',
                        backgroundColor: 'rgba(5, 150, 105, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        pointBackgroundColor: '#059669',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    ...ChartGenerator.getCommonOptions('시간대별 평균 내원환자수'),
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '평균 내원환자수 (명)',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '시간',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        }
                    }
                }
            });
        }

        // 4. 실시간 분당 재실환자수 차트
        function generateRealtimeOccupancyChart() {
            console.log('🏥 실시간 분당 재실환자수 차트 생성 시작...');
            
            if (!patientData) {
                alert('먼저 환자 데이터를 업로드해주세요.');
                return;
            }

            try {
                const result = RealtimeOccupancyCalculator.calculateRealtimeOccupancy(patientData, {
                    maxOccupancy: 35
                });
                
                realtimeOccupancyData = result;
                
                // 시간대별 평균 및 최대값 계산
                const hourlyAverages = [];
                const hourlyMaximums = [];
                const labels = [];
                
                for (let hour = 0; hour < 24; hour++) {
                    const hourStart = hour * 60;
                    const hourEnd = (hour + 1) * 60;
                    
                    let hourSum = 0;
                    let hourMax = 0;
                    for (let minute = hourStart; minute < hourEnd; minute++) {
                        hourSum += result.minuteData[minute];
                        hourMax = Math.max(hourMax, result.minuteData[minute]);
                    }
                    const hourlyAvg = hourSum / 60;
                    
                    hourlyAverages.push(Math.round(hourlyAvg * 10) / 10);
                    hourlyMaximums.push(Math.round(hourMax * 10) / 10);
                    labels.push(`${hour.toString().padStart(2, '0')}:00`);
                }

                const chartHtml = ChartGenerator.createChartContainer('realtimeOccupancyChart', '실시간 분당 재실환자수 분석');
                const container = document.getElementById('patientChartsContainer');
                container.insertAdjacentHTML('afterbegin', chartHtml);

                const ctx = document.getElementById('realtimeOccupancyChart').getContext('2d');
                
                generatedCharts.realtimeOccupancyChart = new Chart(ctx, {
                    type: 'line',
                    plugins: [ChartDataLabels],
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '시간대별 평균',
                            data: hourlyAverages,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        }, {
                            label: '시간대별 최대값',
                            data: hourlyMaximums,
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: '+1',
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: '#dc2626',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `실시간 분당 재실환자수 (최대: ${result.statistics.max}명, 평균: ${result.statistics.average}명)`,
                                font: { size: 18, weight: '600' },
                                color: '#1e293b',
                                padding: 20
                            },
                            legend: {
                                position: 'top',
                                labels: {
                                    font: { size: 12, weight: '500' },
                                    padding: 15,
                                    usePointStyle: true
                                }
                            },
                            datalabels: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: Math.min(50, Math.max(30, result.statistics.max + 5)),
                                title: {
                                    display: true,
                                    text: '재실환자수 (명)',
                                    font: { size: 12, weight: '600' }
                                },
                                grid: { color: '#e2e8f0' },
                                ticks: { 
                                    font: { size: 11 },
                                    precision: 1
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: '시간대',
                                    font: { size: 12, weight: '600' }
                                },
                                grid: { color: '#e2e8f0' },
                                ticks: { font: { size: 11 } }
                            }
                        }
                    }
                });
                
                console.log('✅ 실시간 분당 재실환자수 차트 생성 완료!');
                
            } catch (error) {
                console.error('❌ 실시간 재실환자수 차트 생성 오류:', error);
                alert('실시간 재실환자수 차트 생성 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 5. KTAS별 환자 분포 차트
        function generateKTASDistributionChart() {
            if (!patientData) {
                alert('먼저 환자 데이터를 업로드해주세요.');
                return;
            }

            const ktasStats = {};
            patientData.forEach(patient => {
                const ktas = patient.ktas || 'Unknown';
                ktasStats[ktas] = (ktasStats[ktas] || 0) + 1;
            });

            const ktasLabels = Object.keys(ktasStats).sort();
            const ktasCounts = ktasLabels.map(ktas => ktasStats[ktas]);

            const chartHtml = ChartGenerator.createChartContainer('ktasChart', 'KTAS별 환자 분포');
            const container = document.getElementById('patientChartsContainer');
            container.insertAdjacentHTML('afterbegin', chartHtml);

            const ctx = document.getElementById('ktasChart').getContext('2d');
            generatedCharts.ktasChart = new Chart(ctx, {
                type: 'doughnut',
                plugins: [ChartDataLabels],
                data: {
                    labels: ktasLabels,
                    datasets: [{
                        label: '환자수',
                        data: ktasCounts,
                        backgroundColor: ChartGenerator.getAcademicColorPalette(ktasLabels.length),
                        borderWidth: 3,
                        borderColor: '#ffffff'
                    }]
                },
                options: ChartGenerator.getPieChartOptions('KTAS별 환자 분포')
            });
        }

        // 6. 입원 VS 귀가 분석 차트
        function generateAdmissionVsDischargeChart() {
            if (!patientData) {
                alert('먼저 환자 데이터를 업로드해주세요.');
                return;
            }

            const resultStats = {};
            patientData.forEach(patient => {
                const result = patient.result || 'Unknown';
                resultStats[result] = (resultStats[result] || 0) + 1;
            });

            const resultLabels = Object.keys(resultStats);
            const resultCounts = resultLabels.map(result => resultStats[result]);

            const chartHtml = ChartGenerator.createChartContainer('resultChart', '입원 VS 귀가 분석');
            const container = document.getElementById('patientChartsContainer');
            container.insertAdjacentHTML('afterbegin', chartHtml);

            const ctx = document.getElementById('resultChart').getContext('2d');
            generatedCharts.resultChart = new Chart(ctx, {
                type: 'pie',
                plugins: [ChartDataLabels],
                data: {
                    labels: resultLabels,
                    datasets: [{
                        label: '환자수',
                        data: resultCounts,
                        backgroundColor: ChartGenerator.getAcademicColorPalette(resultLabels.length),
                        borderWidth: 3,
                        borderColor: '#ffffff'
                    }]
                },
                options: ChartGenerator.getPieChartOptions('진료결과별 환자 분포')
            });
        }

        // 7. 입원과별 환자수 차트
        function generateAdmissionDepartmentChart() {
            if (!patientData) {
                alert('먼저 환자 데이터를 업로드해주세요.');
                return;
            }

            const admittedPatients = patientData.filter(patient => 
                patient.admissionDept && patient.admissionDept.trim() !== ''
            );

            if (admittedPatients.length === 0) {
                alert('입원과 데이터가 있는 환자가 없습니다.');
                return;
            }

            const deptStats = {};
            admittedPatients.forEach(patient => {
                const dept = patient.admissionDept.trim();
                deptStats[dept] = (deptStats[dept] || 0) + 1;
            });

            const sortedDepts = Object.keys(deptStats).sort((a, b) => deptStats[b] - deptStats[a]);
            const deptCounts = sortedDepts.map(dept => deptStats[dept]);

            const chartHtml = ChartGenerator.createChartContainer('deptChart', '입원과별 환자수 분석');
            const container = document.getElementById('patientChartsContainer');
            container.insertAdjacentHTML('afterbegin', chartHtml);

            const ctx = document.getElementById('deptChart').getContext('2d');
            
            if (sortedDepts.length > 8) {
                generatedCharts.deptChart = new Chart(ctx, {
                    type: 'doughnut',
                    plugins: [ChartDataLabels],
                    data: {
                        labels: sortedDepts,
                        datasets: [{
                            label: '입원 환자수',
                            data: deptCounts,
                            backgroundColor: ChartGenerator.getAcademicColorPalette(sortedDepts.length),
                            borderWidth: 3,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: ChartGenerator.getPieChartOptions('입원과별 환자수 분포')
                });
            } else {
                generatedCharts.deptChart = new Chart(ctx, {
                    type: 'bar',
                    plugins: [ChartDataLabels],
                    data: {
                        labels: sortedDepts,
                        datasets: [{
                            label: '입원 환자수',
                            data: deptCounts,
                            backgroundColor: ChartGenerator.getAcademicColorPalette(sortedDepts.length),
                            borderColor: '#1e293b',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        ...ChartGenerator.getCommonOptions('입원과별 환자수', true),
                        indexAxis: 'y',
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '환자수 (명)',
                                    font: { size: 12, weight: '600' }
                                },
                                grid: { color: '#e2e8f0' },
                                ticks: { font: { size: 11 } }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '입원과',
                                    font: { size: 12, weight: '600' }
                                },
                                grid: { color: '#e2e8f0' },
                                ticks: { font: { size: 11 } }
                            }
                        }
                    }
                });
            }
        }

        // 8. 응급실 의사별 환자수 차트
        function generateDoctorPatientChart() {
            if (!patientData) {
                alert('먼저 환자 데이터를 업로드해주세요.');
                return;
            }

            const doctorStats = {};
            patientData.forEach(patient => {
                if (patient.doctor !== 'Unknown') {
                    const doctor = patient.doctor;
                    doctorStats[doctor] = (doctorStats[doctor] || 0) + 1;
                }
            });

            const sortedDoctors = Object.keys(doctorStats).sort((a, b) => doctorStats[b] - doctorStats[a]);
            const doctorCounts = sortedDoctors.map(doctor => doctorStats[doctor]);

            const chartHtml = ChartGenerator.createChartContainer('doctorChart', '응급실 의사별 환자수');
            const container = document.getElementById('patientChartsContainer');
            container.insertAdjacentHTML('afterbegin', chartHtml);

            const ctx = document.getElementById('doctorChart').getContext('2d');
            generatedCharts.doctorChart = new Chart(ctx, {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: {
                    labels: sortedDoctors,
                    datasets: [{
                        label: '담당 환자수',
                        data: doctorCounts,
                        backgroundColor: ChartGenerator.getAcademicColorPalette(sortedDoctors.length),
                        borderColor: '#1e293b',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    ...ChartGenerator.getCommonOptions('응급실 의사별 환자수', true),
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '환자수 (명)',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '의사명',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        }
                    }
                }
            });
        }

        // 전체 환자 차트 생성
        function generateAllPatientCharts() {
            console.log('🚀 전체 환자 차트 생성 시작...');
            
            if (!patientData) {
                alert('먼저 환자 데이터를 업로드해주세요.');
                return;
            }

            if (!analysisResults) {
                alert('데이터 분석이 완료되지 않았습니다.');
                return;
            }

            // 기존 차트 모두 제거
            document.getElementById('patientChartsContainer').innerHTML = '';
            generatedCharts = {};

            // 차트 생성 함수들
            const chartFunctions = [
                { func: generateDailyPatientChart, name: '일별 환자수' },
                { func: generateWeeklyAverageChart, name: '요일별 평균환자수' },
                { func: generateHourlyAverageChart, name: '시간대별 내원환자수' },
                { func: generateRealtimeOccupancyChart, name: '실시간 분당 재실환자수' },
                { func: generateKTASDistributionChart, name: 'KTAS별 환자 분포' },
                { func: generateAdmissionVsDischargeChart, name: '입원 VS 귀가 분석' },
                { func: generateAdmissionDepartmentChart, name: '입원과별 환자수' },
                { func: generateDoctorPatientChart, name: '의사별 환자수' }
            ];

            let successCount = 0;
            let errorCount = 0;

            chartFunctions.forEach((chartInfo, index) => {
                try {
                    console.log(`📈 ${index + 1}/8: ${chartInfo.name} 생성 중...`);
                    chartInfo.func();
                    successCount++;
                    console.log(`✅ ${chartInfo.name} 생성 완료`);
                } catch (error) {
                    errorCount++;
                    console.error(`❌ ${chartInfo.name} 생성 오류:`, error);
                }
            });

            setTimeout(() => {
                const totalGenerated = Object.keys(generatedCharts).length;
                console.log(`🎉 차트 생성 완료: 성공 ${successCount}개, 오류 ${errorCount}개`);
                
                if (totalGenerated > 0) {
                    alert(`✅ 총 ${totalGenerated}개의 환자 분석 차트가 생성되었습니다!\n\n성공: ${successCount}개\n오류: ${errorCount}개`);
                } else {
                    alert('❌ 차트 생성에 실패했습니다. 데이터를 다시 확인해주세요.');
                }
            }, 1000);
        }

        // 개별 차트 생성 함수들에 오류 처리 추가
        function safeGenerateChart(chartFunction, chartName) {
            try {
                console.log(`📊 ${chartName} 차트 생성 시작...`);
                chartFunction();
                console.log(`✅ ${chartName} 차트 생성 완료`);
            } catch (error) {
                console.error(`❌ ${chartName} 차트 생성 오류:`, error);
                alert(`${chartName} 차트 생성 중 오류가 발생했습니다:\n${error.message}`);
            }
        }

        /* ========================================
           📦 MODULE: 스케줄 관리 함수들
           ======================================== */
        function loadSampleSchedule() {
            const sampleData = `1|화|이||강|강|정|
2|수|허||박|박|강|
3|목|권||강|오|선|
4|금|오||박|박|허|
5|토|선||강|강|권|
6|일|박|이2|||허|이
7|월|선||강|이2|이|`;

            document.getElementById('scheduleData').value = sampleData;
        }

        function processScheduleData() {
            const rawData = document.getElementById('scheduleData').value.trim();
            
            if (!rawData) {
                alert('스케줄 데이터를 입력해주세요.');
                return;
            }

            try {
                scheduleData = ScheduleManager.parseScheduleData(rawData);
                displayScheduleTable();
                
                // 스케줄 데이터 저장
                DataManager.saveData(scheduleData, '근무스케줄_' + new Date().toLocaleDateString(), 'schedule');
                refreshDataList();
                
                document.getElementById('scheduleResults').style.display = 'block';
                
            } catch (error) {
                alert('스케줄 데이터 처리 중 오류가 발생했습니다: ' + error.message);
            }
        }

        function displayScheduleTable() {
            const table = document.getElementById('scheduleTable');
            
            let html = `
                <thead>
                    <tr>
                        <th>날짜</th>
                        <th>요일</th>
                        <th>Day 1</th>
                        <th>Day 2</th>
                        <th>MDH</th>
                        <th>MD</th>
                        <th>Night 1</th>
                        <th>Night 2</th>
                    </tr>
                </thead>
                <tbody>
            `;

            const sortedDays = Object.keys(scheduleData).sort((a, b) => parseInt(a) - parseInt(b));

            sortedDays.forEach(day => {
                const data = scheduleData[day];
                const isWeekend = data.day === '토' || data.day === '일';
                const rowClass = isWeekend ? 'weekend-row' : '';
                
                html += `
                    <tr class="${rowClass}">
                        <td><strong>${day}</strong></td>
                        <td><strong>${data.day}</strong></td>
                        <td>${data.d1 || ''}</td>
                        <td>${data.d2 || ''}</td>
                        <td>${data.mdh || ''}</td>
                        <td>${data.md || ''}</td>
                        <td>${data.n1 || ''}</td>
                        <td>${data.n2 || ''}</td>
                    </tr>
                `;
            });

            html += '</tbody>';
            table.innerHTML = html;
        }

        // 의사별 총 근무시간 차트 생성
        function generateDoctorWorkHoursChart() {
            if (!scheduleData || Object.keys(scheduleData).length === 0) {
                alert('먼저 스케줄 데이터를 처리해주세요.');
                return;
            }

            console.log('📊 의사별 총 근무시간 차트 생성 중...');

            const workHours = ScheduleManager.calculateTotalWorkHours(scheduleData);
            const staffList = Object.keys(workHours).filter(staff => workHours[staff] > 0);
            const totalHours = staffList.map(staff => workHours[staff]);

            const chartHtml = ChartGenerator.createChartContainer('doctorWorkHoursChart', '의사별 총 근무시간 분석');
            const container = document.getElementById('scheduleChartsContainer');
            container.innerHTML = chartHtml;

            const ctx = document.getElementById('doctorWorkHoursChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: {
                    labels: staffList,
                    datasets: [{
                        label: '총 근무시간 (시간)',
                        data: totalHours,
                        backgroundColor: ChartGenerator.getAcademicColorPalette(staffList.length),
                        borderColor: '#1e293b',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    ...ChartGenerator.getCommonOptions('의사별 총 근무시간', true),
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '근무시간 (시간)',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '의사명',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '의사별 총 근무시간 (D: 10h, MDH: 4h, MD: 9h, N: 14h)',
                            font: { size: 16, weight: '600' },
                            color: '#1e293b',
                            padding: 20
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 12, weight: '500' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            font: { weight: '600', size: 11 },
                            color: '#1e293b',
                            formatter: function(value, context) {
                                return value + 'h';
                            }
                        }
                    }
                }
            });

            console.log('✅ 의사별 총 근무시간 차트 생성 완료');
        }

        function generateWorkloadAnalysis() {
            if (!scheduleData || Object.keys(scheduleData).length === 0) {
                alert('먼저 스케줄 데이터를 처리해주세요.');
                return;
            }

            const workloadStats = ScheduleManager.calculateWorkloadStats(scheduleData);
            const staffList = Object.keys(workloadStats).filter(staff => workloadStats[staff].total > 0);
            const totalShifts = staffList.map(staff => workloadStats[staff].total);

            const chartHtml = ChartGenerator.createChartContainer('workloadAnalysisChart', '근무량 분석 (근무 횟수)');
            const container = document.getElementById('scheduleChartsContainer');
            container.innerHTML += chartHtml;

            const ctx = document.getElementById('workloadAnalysisChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: {
                    labels: staffList,
                    datasets: [{
                        label: '총 근무 횟수',
                        data: totalShifts,
                        backgroundColor: ChartGenerator.getAcademicColorPalette(staffList.length),
                        borderColor: '#1e293b',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    ...ChartGenerator.getCommonOptions('의사별 총 근무 횟수', true),
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '근무 횟수',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '의사명',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: '#e2e8f0' },
                            ticks: { font: { size: 11 } }
                        }
                    }
                }
            });
        }

        /* ========================================
           📦 MODULE: 데이터 관리 함수들
           ======================================== */
        function refreshDataList() {
            const dataKeys = DataManager.getStoredDataKeys();
            const container = document.getElementById('dataList');
            
            // 임시 메모리 데이터도 포함
            const tempKeys = window.tempDataStorage ? Object.keys(window.tempDataStorage) : [];
            const allKeys = [...dataKeys, ...tempKeys];
            
            if (allKeys.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-3"></i><br>
                        아직 업로드된 데이터가 없습니다.
                    </div>
                `;
                return;
            }

            // 저장소 상태 표시
            const storageStatus = DataManager.getStorageStatus();
            let statusHtml = '';
            
            if (storageStatus.temporaryDatasets > 0) {
                statusHtml = `
                    <div class="alert alert-warning alert-sm mb-3" role="alert">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>저장소 알림:</strong> ${storageStatus.temporaryDatasets}개 데이터가 임시 메모리에 저장되어 있습니다.
                        <br><small>페이지를 새로고침하면 임시 데이터가 사라집니다.</small>
                    </div>
                `;
            }

            let html = statusHtml;
            
            // 영구 저장된 데이터
            dataKeys.forEach(key => {
                const data = DataManager.loadData(key);
                if (data) {
                    const isSelected = key === selectedDataKey ? 'selected' : '';
                    const storageType = '💾 영구저장';
                    
                    html += `
                        <div class="data-item ${isSelected}" onclick="selectData('${key}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">
                                        ${data.name} 
                                        <small class="badge bg-success">${storageType}</small>
                                    </h6>
                                    <small class="text-muted">${data.type} | ${new Date(data.timestamp).toLocaleString()}</small>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteData('${key}', event)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }
            });
            
            // 임시 메모리 데이터
            tempKeys.forEach(key => {
                const data = window.tempDataStorage[key];
                if (data) {
                    const isSelected = key === selectedDataKey ? 'selected' : '';
                    const storageType = '📝 임시저장';
                    
                    html += `
                        <div class="data-item ${isSelected}" onclick="selectData('${key}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">
                                        ${data.name} 
                                        <small class="badge bg-warning text-dark">${storageType}</small>
                                    </h6>
                                    <small class="text-muted">${data.type} | ${new Date(data.timestamp).toLocaleString()}</small>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteData('${key}', event)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        }

        function selectData(key) {
            selectedDataKey = key;
            const data = DataManager.loadData(key);
            
            if (data) {
                // 선택된 데이터 정보 표시
                document.getElementById('selectedDataInfo').style.display = 'block';
                document.getElementById('dataInfoContent').innerHTML = `
                    <h6>${data.name}</h6>
                    <p><strong>타입:</strong> ${data.type}</p>
                    <p><strong>업로드 시간:</strong> ${new Date(data.timestamp).toLocaleString()}</p>
                    <p><strong>데이터 크기:</strong> ${Array.isArray(data.data) ? data.data.length + '개 레코드' : '1개 객체'}</p>
                `;
                
                refreshDataList();
            }
        }

        function analyzeSelectedData() {
            if (!selectedDataKey) {
                alert('먼저 분석할 데이터를 선택해주세요.');
                return;
            }

            const data = DataManager.loadData(selectedDataKey);
            if (!data) {
                alert('선택된 데이터를 불러올 수 없습니다.');
                return;
            }

            if (data.type === 'patient') {
                patientData = data.data;
                analysisResults = PatientAnalyzer.generateSummaryStats(patientData);
                displayPatientAnalysis();
                
                // 환자 데이터 분석 탭으로 이동
                const patientTab = new bootstrap.Tab(document.getElementById('patient-tab'));
                patientTab.show();
                
                alert('✅ 선택된 환자 데이터로 분석을 시작합니다.');
                
            } else if (data.type === 'schedule') {
                scheduleData = data.data;
                displayScheduleTable();
                document.getElementById('scheduleResults').style.display = 'block';
                
                // 스케줄 관리 탭으로 이동
                const scheduleTab = new bootstrap.Tab(document.getElementById('schedule-tab'));
                scheduleTab.show();
                
                alert('✅ 선택된 스케줄 데이터로 분석을 시작합니다.');
            }
        }

        function deleteData(key, event) {
            event.stopPropagation();
            
            if (confirm('이 데이터를 삭제하시겠습니까?')) {
                const success = DataManager.deleteData(key);
                if (success) {
                    if (selectedDataKey === key) {
                        selectedDataKey = null;
                        document.getElementById('selectedDataInfo').style.display = 'none';
                    }
                    refreshDataList();
                    alert('✅ 데이터가 삭제되었습니다.');
                } else {
                    alert('❌ 데이터 삭제에 실패했습니다.');
                }
            }
        }

        function clearAllData() {
            if (confirm('모든 저장된 데이터를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.')) {
                DataManager.clearAllData();
                selectedDataKey = null;
                patientData = null;
                scheduleData = {};
                
                // UI 초기화
                document.getElementById('selectedDataInfo').style.display = 'none';
                document.getElementById('patientAnalysisResults').style.display = 'none';
                document.getElementById('scheduleResults').style.display = 'none';
                document.getElementById('patientChartsContainer').innerHTML = '';
                document.getElementById('scheduleChartsContainer').innerHTML = '';
                
                refreshDataList();
                alert('✅ 모든 데이터가 삭제되었습니다.');
            }
        }

        console.log('🏥 응급실 통합 모니터링 시스템 로드 완료');
    </script>
</body>
</html>